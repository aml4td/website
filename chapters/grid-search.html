<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.521">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Applied Machine Learning for Tabular Data - 4&nbsp; Optimization via Grid Search</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/initial-data-splitting.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <a class="flex-grow-1 no-decor" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
          <h1 class="quarto-secondary-nav-title"><span id="sec-grid" class="quarto-section-identifier"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Optimization via Grid Search</span></span></h1>
        </a>     
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../"></a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/aml4td/website/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/news.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">News</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/contributing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contributing</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/whole-game.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">The Whole Game</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Preparation</span></span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/initial-data-splitting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Initial Data Splitting</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Optmization</span></span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/grid-search.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Optimization via Grid Search</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Classification</span></span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Regression</span></span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Characterization</span></span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Finalization</span></span>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-regular-grid" id="toc-sec-regular-grid" class="nav-link active" data-scroll-target="#sec-regular-grid"><span class="header-section-number">4.1</span> Regular grids</a></li>
  <li><a href="#sec-irregular-grid" id="toc-sec-irregular-grid" class="nav-link" data-scroll-target="#sec-irregular-grid"><span class="header-section-number">4.2</span> Irregular grids</a></li>
  <li><a href="#sec-efficient-grid" id="toc-sec-efficient-grid" class="nav-link" data-scroll-target="#sec-efficient-grid"><span class="header-section-number">4.3</span> Efficient Computations for Grid Search</a></li>
  <li><a href="#sec-racing" id="toc-sec-racing" class="nav-link" data-scroll-target="#sec-racing"><span class="header-section-number">4.4</span> Grid Search via Racing</a></li>
  <li><a href="#sec-nested-resampling" id="toc-sec-nested-resampling" class="nav-link" data-scroll-target="#sec-nested-resampling"><span class="header-section-number">4.5</span> Optimization Bias and Nested Resampling</a></li>
  <li><a href="#chapter-references" id="toc-chapter-references" class="nav-link" data-scroll-target="#chapter-references">Chapter References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span id="sec-grid" class="quarto-section-identifier"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Optimization via Grid Search</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Grid search is a method to optimize tuning parameters for models and/or their preprocessors. It creates a pre-defined set of candidate values and computes performance from each. From there, the numerically best candidate could be chosen, or the relationship between the tuning parameters and model performance can be inspected to see if additional optimization might benefit the model.</p>
<p>Suppose there is a single tuning parameter, as in the learning rate example of <span class="quarto-unresolved-ref">?sec-grid-and-sequential</span>, each candidate takes a scalar value (quantitative or qualitative). In other cases, there are multiple tuning parameters, such as the K-nearest neighbors example shown below. In this case, a candidate is multi-dimensional.</p>
<p>The previous chapter demonstrated that using external data to evaluate the model is crucial (be it resampling or a validation set). Grid search has no free lunch: we cannot simply fit the model and evaluate it by predicting the same data.</p>
<p><span class="citation" data-cites="alg-grid-search">(<a href="#ref-alg-grid-search" role="doc-biblioref"><strong>alg-grid-search?</strong></a>)</span> illustrates the process. For a model with <span class="math inline">\(m\)</span> tuning parameters, we let <span class="math inline">\(\Theta\)</span> represent the collection of <span class="math inline">\(s\)</span> candidate values. For each specific value (<span class="math inline">\(\theta_j\)</span>), we resample the model to produce some measure of efficacy (e.g., <span class="math inline">\(R^2\)</span>, accuracy, etc.)<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. From there, the best value is chosen, or additional work is carried out to find a suitable candidate.</p>
<div class="columns">
<div class="column" style="width:20%;">

</div><div class="column" style="width:60%;">
<div id="alg-grid-search" class="pseudocode-container" data-no-end="false" data-line-number="true" data-pseudocode-index="1" data-comment-delimiter="//" data-line-number-punc=":" data-indent-size="1.2em" data-alg-title="Algorithm">
<div class="pseudocode">
\begin{algorithm} \caption{Grid search for tuning parameter optimization that loops over the resampling algorithm shown in TODO.} \begin{algorithmic} \State $D$: training set \State $B$: number of resamples \State $f()$: modeling function \State $\Theta$: Parameter set ($s \times m$) with candidates $\theta_j$ \For{$j=1$ \To $m$} \State Generate $\bar{Q}_{j} =$ \Call{Resample}{$D, B, f(\cdot; \theta_j)$} corresponding to candidate $\theta_j$. \EndFor \State Determine $\hat{\theta}_{opt}$ that optimizes $\bar{Q}_{j}$. \end{algorithmic} \end{algorithm}
</div>
</div>
</div><div class="column" style="width:20%;">

</div>
</div>
<p>To demonstrate, this chapter will initially focus on grids for a K-nearest neighbors (KNN) model with two tuning parameters<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>:</p>
<ul>
<li>The number of neighbors (from 1 to 50 neighbors).</li>
<li>The Minkowski distance order (values ranging from 1.0 to 2.0).</li>
</ul>
<p>We’ll illustrate different strategies using this model setup with varying configurations of these three tuning parameters.</p>
<p>There are two main classes of grids: regular and irregular. We can view generating a collection of candidate models as a statistical design of experiments (DOE) problem <span class="citation" data-cites="BHH">(<a href="#ref-BHH" role="doc-biblioref">Box, Hunter, and Hunter 1978</a>)</span>. There is a long history of DOE, and we’ll invoke relevant methods for each grid type. <span class="citation" data-cites="santner2018design">Santner, Williams, and Notz (<a href="#ref-santner2018design" role="doc-biblioref">2018</a>)</span> and <span class="citation" data-cites="gramacy2020surrogates">Gramacy (<a href="#ref-gramacy2020surrogates" role="doc-biblioref">2020</a>)</span> have excellent overviews of the DOE methods discussed in this chapter.</p>
<p>The following two sections describe different methods for creating the candidate set <span class="math inline">\(\Theta\)</span>. Subsequent sections describe strategies for making grid search efficient using tools such as parallel processing and model racing.</p>
<section id="sec-regular-grid" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="sec-regular-grid"><span class="header-section-number">4.1</span> Regular grids</h2>
<p>A regular grid starts with a sequence or set of values for each tuning parameter and then creates all combinations. In statistics, this is referred to as a factorial design. The number of values per tuning parameter does not have to be the same. To illustrate a regular grid, we’ll use four values of the number of neighbors, all three weight functions, and two values of the distance order. This grid of 15 candidates is shown in <a href="#fig-knn-grids" class="quarto-xref">Figure&nbsp;<span>4.1</span></a>. Each weight function occurs at the same values as the other two parameter values. The grid covers the entire space with significant gaps in between.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-knn-grids" class="quarto-figure quarto-figure-center anchored" width="75%" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-knn-grids-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../figures/fig-knn-grids-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-knn-grids-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.1: Three types of grids (in columns) are illustrated with tuning parameters from a K-nearest neighbor model. Each grid contains 16 candidates. The space-filling design was created using the MaxiMin method described in <a href="#sec-irregular-grid" class="quarto-xref"><span>Section&nbsp;4.2</span></a>.
</figcaption>
</figure>
</div>
</div>
</div>
<p><a href="#fig-knn-regular-grid-tuning" class="quarto-xref">Figure&nbsp;<span>4.2</span></a> plots the results when tuning the simulated training set in <span class="quarto-unresolved-ref">?sec-complexity-overfitting</span> with five repeats of 10-fold cross-validation. Brier scores were used to measure how well the model succeeded at predicting the data. The plot shows that using a small number of nearest neighbors is terrible (due to overfitting), the Minkowski distance parameter matters little for these data, and the inverse distance function performs better than rectangular. Even though this is not a diverse set of candidate values, we can probably pick out a reasonable candidate with a small Brier score, such as 13 neighbors and and a Minkowski distance order of 2.0.</p>
<p>The nice thing about regular grids is that you can learn much from the tuning results. It is possible for tuning parameters to interact with one another (in the same manner as predictors in <span class="quarto-unresolved-ref">?sec-interactions</span>). This can usually be seen when visualizing the results of a regular grid. In our KNN example, the three profiles have roughly the same relationship with the performance metric. This indicates that the impact of these parameters is additive. Understanding how a model’s tuning parameters affect performance can help improve model optimization.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-knn-regular-grid-tuning" class="quarto-figure quarto-figure-center anchored" width="50%" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-knn-regular-grid-tuning-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../figures/fig-knn-regular-grid-tuning-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-knn-regular-grid-tuning-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.2: The tuning results for the regular grid shown in <a href="#fig-knn-grids" class="quarto-xref">Figure&nbsp;<span>4.1</span></a>.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The primary downside to regular grids is that, as the number of tuning parameters increases, the number of points required to fill the space becomes extremely large (due to the curve of dimensionality). However, for some models and pre-processing methods, regular grids can be very efficient despite the number of tuning parameters (see the following section that describes the “submodel trick”).</p>
</section>
<section id="sec-irregular-grid" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="sec-irregular-grid"><span class="header-section-number">4.2</span> Irregular grids</h2>
<p>Irregular grids are not factorial in nature. A simple example is a <em>random grid</em> where points are randomly placed using a uniform distribution. A design of size 15 is shown in <a href="#fig-knn-grids" class="quarto-xref">Figure&nbsp;<span>4.1</span></a>. There are some gaps and clustering of the points, but the space is covered well. The tuning results are shown in the top panel of <a href="#fig-knn-irregular-grid-tuning" class="quarto-xref">Figure&nbsp;<span>4.3</span></a>. Because it is an irregular design, we can’t use the same visualization as in <a href="#fig-knn-regular-grid-tuning" class="quarto-xref">Figure&nbsp;<span>4.2</span></a>. Instead, a “marginal” plot is shown, where each numeric tuning parameter is plotted against performance in a separate panel. Here, it is clear that using few neighbors is terrible and that the Minkowski distance parameter has little effect on the results. It is more challenging to see that there is a slight but reliable difference in the weighting function. The numerically best candidate was not too dissimilar from the regular grid: 17 neighbors and and a Minkowski distance order of 1.3.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-knn-irregular-grid-tuning" class="quarto-figure quarto-figure-center anchored" width="80%" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-knn-irregular-grid-tuning-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../figures/fig-knn-irregular-grid-tuning-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-knn-irregular-grid-tuning-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.3: The tuning results for the irregular grids shown in <a href="#fig-knn-grids" class="quarto-xref">Figure&nbsp;<span>4.1</span></a>.
</figcaption>
</figure>
</div>
</div>
</div>
<p>For this example, the patterns for the number of neighbors do not change across values of the Minkowski distance parameter (i.e., there is no interaction). If this were not the case, the relationship between these parameters and performance would be much more difficult to understand. Examples of this will be seen in later chapters, such as in TODO and TODO.</p>
<p>Another type of irregular grid is a <em>space-filling design</em> <span class="citation" data-cites="joseph2016space">(<a href="#ref-joseph2016space" role="doc-biblioref">Joseph 2016</a>)</span>, where the goal is to make sure that the tuning parameter space is covered and that there is minimal redundancy in the candidate values. There are a variety of methods for achieving this goal.</p>
<p>The Latin hypercube design (LHD) is the most popular method for constructing space-filling designs <span class="citation" data-cites="Viana2016 husslage2011space">(<a href="#ref-husslage2011space" role="doc-biblioref">Husslage et al. 2011</a>; <a href="#ref-Viana2016" role="doc-biblioref">Viana 2016</a>)</span>. These designs have a simple definition. If our hyperparameter space is rectangular and partitioned into smaller (hyper)cubes, a LHD is a set of distinct points. For our application, and most others, this definition is inadequate<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. We desire candidates that fill the space and are not close to one another.</p>
<p>The most basic approach to creating a LHD is using random sampling <span class="citation" data-cites="Mckay2000">(<a href="#ref-Mckay2000" role="doc-biblioref">Mckay, Beckman, and Conover 2000</a>)</span>. If there are <span class="math inline">\(m\)</span> parameters and we request <span class="math inline">\(s\)</span> candidate values, the parameter space is initially divided into <span class="math inline">\(s^m\)</span> hypercubes of equal size. For each tuning parameter, a random value is created for each of the <span class="math inline">\(s\)</span> bins in that dimension. Suppose there are five bins for a parameter that ranges between zero and one. We randomly order the bins and then create a random number in the bin range. If the first design point selects bin two, a random uniform value is created in the range <code>[0.2 0.4)</code>. This process continues for each parameter. <a href="#fig-lhs-sampled" class="quarto-xref">Figure&nbsp;<span>4.4</span></a> shows three such designs, each generated with different random numbers.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-lhs-sampled" class="quarto-figure quarto-figure-center anchored" width="80%" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-lhs-sampled-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../figures/fig-lhs-sampled-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lhs-sampled-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.4: Three replicate Latin hypercube sampling designs of size five for two parameters. Each design uses different random numbers. The grid lines illustrate the 25 hypercubes used to generate the values.
</figcaption>
</figure>
</div>
</div>
</div>
<p>While the points do not overlap, each design covers the parameter space poorly. Additional constraints can be used to make the design more consistent with our desires.</p>
<p>For example, we could choose points to maximize the minimum pairwise distances between the candidates. These designs are usually referred to as MaxiMin designs <span class="citation" data-cites="pronzato2017minimax">(<a href="#ref-pronzato2017minimax" role="doc-biblioref">Pronzato 2017</a>)</span>. Comparing the two irregular designs in <a href="#fig-knn-grids" class="quarto-xref">Figure&nbsp;<span>4.1</span></a>, the random grid has a maximum minimum distance value of 0.08. In contrast, the corresponding space-filling design’s value (0.25) is 3.1-fold larger<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>. The latter design was optimized for this criterion, and we can see far less redundancy in the optimized design.</p>
<p>A similar method, initially proposed by <span class="citation" data-cites="audze1977new">Audze and Eglais (<a href="#ref-audze1977new" role="doc-biblioref">1977</a>)</span>, maximizes a function of the inverse distances between <span class="math inline">\(s\)</span> candidate points:</p>
<p><span class="math display">\[
criterion = \sum_{i=1}^s \sum_{j=1,\;i\ne j}^s\frac{1}{dist(\theta_i, \theta_j)^2}
\]</span> <span class="citation" data-cites="bates2004formulation">Bates, Sienz, and Toropov (<a href="#ref-bates2004formulation" role="doc-biblioref">2004</a>)</span> devised search methods to find optimal designs for this criterion.</p>
<p>Additionally, maximum entropy sampling selects points based on assumptions related to the distributions of the tuning parameters and their covariance matrix <span class="citation" data-cites="shewry1987maximum joseph2015maximum">(<a href="#ref-shewry1987maximum" role="doc-biblioref">Shewry and Wynn 1987</a>; <a href="#ref-joseph2015maximum" role="doc-biblioref">Joseph, Gul, and Ba 2015</a>)</span>.</p>
<p>While these methods can be constructed generally by sampling random points and using a search method to optimize a specific criterion, there has been scholarship that has pre-optimized designs for some combination of the number of tuning parameters and the requested grid size.</p>
<p>The lower panel of <a href="#fig-knn-irregular-grid-tuning" class="quarto-xref">Figure&nbsp;<span>4.3</span></a> shows the tuning results for the Audze-Eglais design. The results are somewhat cleaner than the random grid results but would lead to the same conclusions. Here, the best candidate was nearly identical to the random grid: 18 neighbors and and a Minkowski distance order of 1.8.</p>
<p>The advantage of space-filling designs over random designs is that, for smaller designs, the candidates do a better job covering the space and have a low probability of producing redundant points. Also, it is possible to create a space-filling design so that the candidates for each numerical parameter are nearly equally spaced (as was done in <a href="#fig-knn-grids" class="quarto-xref">Figure&nbsp;<span>4.1</span></a>).</p>
<p>So far, the Latin hypercube design math assumes that all of the tuning parameter values are quantitative in nature. That’s not the case in our example. There are only two values of the weighting function. As a simple workaround, these two parameter values are repeated as if they were <span class="math inline">\(s\)</span> distinct values when making the design. This allows them to be used with a Latin hypercube design and any space-filling design that uses this approach is not technically optimal. Practically speaking, this is an effective approach for tuning models. However, there are <em>sliced</em> LHD that can accomplish the same goal <span class="citation" data-cites="qian2012sliced ba2015optimal">(<a href="#ref-qian2012sliced" role="doc-biblioref">Qian 2012</a>; <a href="#ref-ba2015optimal" role="doc-biblioref">Ba, Myers, and Brenneman 2015</a>)</span>.</p>
<ul>
<li>The distance weighting function (qualitative with values “rectangular” and “inverse”).</li>
</ul>
<p>We recommend space-filling designs since they are more efficient than regular designs. Regular designs have a lot of benefits when using an unfamiliar modeling methodology since you will learn a lot more about the nuances of how the tuning parameters affect one another.</p>
</section>
<section id="sec-efficient-grid" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="sec-efficient-grid"><span class="header-section-number">4.3</span> Efficient Computations for Grid Search</h2>
<p>The computational cost of grid search can become large, depending on the resampling strategy and the number of candidates under consideration. In our example, a total of 750 KNN models are evaluated before determining which candidates are most favorable to our data.</p>
<p>Fortunately, none of these 750 models depend on one another and can be computed separately. Since almost all modern computers have multiple CPUs and GPUs, we can break the computations into different “chunks” of work and execute them simultaneously on other processors (or separate computers entirely). The parallel processing of models can significantly reduce the time it takes to tune using grid search.</p>
<p>when does this become more effective?</p>
<p>Despite the meager computation costs of tuning the KNN model, there was still a 5.3-fold speedup (11.9s versus 2.3s) when using 10 parallel workers. There are some nuances related to parallel processing. It is an excellent idea to parallelize the “longest loop” (literally or figuratively).</p>
<ul>
<li>Parallel individual model fits or resampling.</li>
<li>data preprocessing conditional computations</li>
<li>keep data on one core or shotgun approach See <span class="citation" data-cites="tmwr">Kuhn and Silge (<a href="#ref-tmwr" role="doc-biblioref">2022</a>)</span> <a href="https://www.tmwr.org/grid-search#parallel-processing">Section 13.5.2</a></li>
</ul>
<p>TODO move all timing computations to a separate file for batch processing</p>
<p>Also, some models can exploit the “submodel trick,” where a single training model can predict many tuning parameter candidates. For example, the glmnet model (<span class="quarto-unresolved-ref">?sec-penalized-logistic-regression</span>) can compute the model coefficients for <em>all</em> penalty values. If we tune the penalty value, a single model fit can evaluate numerous candidate values (assuming all other tuning parameters are the same). For a regular grid, this can effectively drop a dimension of the computations. Some different models and pre-processors can have this quality, including boosted trees (<span class="quarto-unresolved-ref">?sec-boosting-cls</span>), partial least squares (<span class="quarto-unresolved-ref">?sec-colinear-projections</span>), principal component feature extraction (<span class="quarto-unresolved-ref">?sec-linear-feature-extraction</span>), and others.</p>
<p>Unfortunately, irregular designs cannot exploit the submodel trick mentioned in the previous section.</p>
</section>
<section id="sec-racing" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="sec-racing"><span class="header-section-number">4.4</span> Grid Search via Racing</h2>
<p>Summed up in <span class="citation" data-cites="alg-race">(<a href="#ref-alg-race" role="doc-biblioref"><strong>alg-race?</strong></a>)</span>.</p>
<div class="columns">
<div class="column" style="width:10%;">

</div><div class="column" style="width:80%;">
<div id="alg-race" class="pseudocode-container" data-no-end="false" data-line-number="true" data-pseudocode-index="2" data-comment-delimiter="//" data-line-number-punc=":" data-indent-size="1.2em" data-alg-title="Algorithm">
<div class="pseudocode">
\begin{algorithm} \caption{Racing tuning parameter optimization} \begin{algorithmic} \State $D$: training set \State $B$: number of resamples \State Define initial number of resamples $1 \lt B_{min} \lt B$ \State $f()$: modeling function \State $\Theta$: Parameter set ($s \times m$) with candidates $\theta_j$ \For{$j=1$ \To $m$} \State Generate $\bar{Q}_{j} =$ \Call{Resample}{$D, B_{min}, f(\cdot; \theta_j)$} corresponding to candidate $\theta_j$. \EndFor \State Eliminate candidates so that only $s_i$ remain. \For{$k = B_{min} + 1$ \To $B$} \State Generate $\bar{Q}_j^k =$ \Call{Resample}{$D, k, f(\cdot; \theta_j)$} corresponding to candidate $\theta_j$ as of resample $k$. \State Eliminate candidates so that only $s_k$ remain. \Endfor \State Determine $\hat{\theta}_{opt}$ that optimizes $\bar{Q}_j^k$. \end{algorithmic} \end{algorithm}
</div>
</div>
</div><div class="column" style="width:10%;">

</div>
</div>
</section>
<section id="sec-nested-resampling" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="sec-nested-resampling"><span class="header-section-number">4.5</span> Optimization Bias and Nested Resampling</h2>
</section>
<section id="chapter-references" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="chapter-references">Chapter References</h2>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-audze1977new" class="csl-entry" role="listitem">
Audze, P, and V Eglais. 1977. <span>“<a href="https://scholar.google.com/scholar?hl=en&amp;as_sdt=0%2C7&amp;q=New+approach+to+planning+out+of+experiments&amp;as_ylo=1977&amp;as_yhi=1977&amp;btnG=">New Approach to Planning Out of Experiments</a>.”</span> <em>Problems of Dynamics and Strengths</em> 35: 104–7.
</div>
<div id="ref-ba2015optimal" class="csl-entry" role="listitem">
Ba, S, R Myers, and W Brenneman. 2015. <span>“<a href="https://scholar.google.com/scholar?hl=en&amp;as_sdt=0%2C7&amp;q=Optimal+sliced+Latin+hypercube+designs&amp;as_ylo=2015&amp;as_yhi=2015&amp;btnG=">Optimal Sliced Latin Hypercube Designs</a>.”</span> <em>Technometrics</em> 57 (4): 479–87.
</div>
<div id="ref-bates2004formulation" class="csl-entry" role="listitem">
Bates, S, J Sienz, and V Toropov. 2004. <span>“Formulation of the Optimal Latin Hypercube Design of Experiments Using a Permutation Genetic Algorithm.”</span> In <em>45th AIAA/ASME/ASCE/AHS/ASC Structures, Structural Dynamics &amp; Materials Conference</em>, 2011.
</div>
<div id="ref-BHH" class="csl-entry" role="listitem">
Box, GEP, W Hunter, and J. Hunter. 1978. <em>Statistics for Experimenters</em>. New York: Wiley.
</div>
<div id="ref-gramacy2020surrogates" class="csl-entry" role="listitem">
Gramacy, R. 2020. <em><a href="https://bookdown.org/rbg/surrogates">Surrogates: <span>Gaussian</span> Process Modeling, Design, and Optimization for the Applied Sciences</a></em>. CRC press.
</div>
<div id="ref-husslage2011space" class="csl-entry" role="listitem">
Husslage, B, G Rennen, E Van Dam, and D Den Hertog. 2011. <span>“<a href="https://scholar.google.com/scholar?hl=en&amp;as_sdt=0%2C7&amp;q=Space+filling+Latin+hypercube+designs+for+computer+experiments&amp;as_ylo=2011&amp;as_yhi=2011&amp;btnG=">Space-Filling <span>Latin</span> Hypercube Designs for Computer Experiments</a>.”</span> <em>Optimization and Engineering</em> 12: 611–30.
</div>
<div id="ref-joseph2016space" class="csl-entry" role="listitem">
Joseph, V. 2016. <span>“<a href="https://scholar.google.com/scholar?hl=en&amp;as_sdt=0%2C7&amp;q=Space+filling+designs+for+computer+experiments+A+review&amp;as_ylo=2016&amp;as_yhi=2016&amp;btnG=">Space-Filling Designs for Computer Experiments: <span>A</span> Review</a>.”</span> <em>Quality Engineering</em> 28 (1): 28–35.
</div>
<div id="ref-joseph2015maximum" class="csl-entry" role="listitem">
Joseph, V, E Gul, and S Ba. 2015. <span>“<a href="https://scholar.google.com/scholar?hl=en&amp;as_sdt=0%2C7&amp;q=Maximum+projection+designs+for+computer+experiments&amp;as_ylo=2015&amp;as_yhi=2015&amp;btnG=">Maximum Projection Designs for Computer Experiments</a>.”</span> <em>Biometrika</em> 102 (2): 371–80.
</div>
<div id="ref-tmwr" class="csl-entry" role="listitem">
Kuhn, M, and J Silge. 2022. <em><a href="https://www.tmwr.org">Tidy Modeling with <span>R</span></a></em>. O’Reilly Media, Inc.
</div>
<div id="ref-Mckay2000" class="csl-entry" role="listitem">
Mckay, M, R Beckman, and W Conover. 2000. <span>“<a href="https://scholar.google.com/scholar?hl=en&amp;as_sdt=0%2C7&amp;q=A+comparison+of+three+methods+for+selecting+values+of+input+variables+in+the+analysis+of+output+from+a+computer+code&amp;as_ylo=2000&amp;as_yhi=2000&amp;btnG=">A Comparison of Three Methods for Selecting Values of Input Variables in the Analysis of Output from a Computer Code</a>.”</span> <em>Technometrics</em> 42 (1): 55–61.
</div>
<div id="ref-pronzato2017minimax" class="csl-entry" role="listitem">
Pronzato, L. 2017. <span>“<a href="https://scholar.google.com/scholar?hl=en&amp;as_sdt=0%2C7&amp;q=Minimax+and+maximin+space+filling+designs+some+properties+and+methods+for+construction&amp;as_ylo=2017&amp;as_yhi=2017&amp;btnG=">Minimax and Maximin Space-Filling Designs: Some Properties and Methods for Construction</a>.”</span> <em>Journal de La Société Française de Statistique</em> 158 (1): 7–36.
</div>
<div id="ref-qian2012sliced" class="csl-entry" role="listitem">
Qian, P. 2012. <span>“<a href="https://scholar.google.com/scholar?hl=en&amp;as_sdt=0%2C7&amp;q=Sliced+Latin+hypercube+designs&amp;as_ylo=2012&amp;as_yhi=2012&amp;btnG=">Sliced Latin Hypercube Designs</a>.”</span> <em>Journal of the American Statistical Association</em> 107 (497): 393–99.
</div>
<div id="ref-santner2018design" class="csl-entry" role="listitem">
Santner, T, B Williams, and W Notz. 2018. <em>The Design and Analysis of Computer Experiments</em>. Springer.
</div>
<div id="ref-shewry1987maximum" class="csl-entry" role="listitem">
Shewry, M, and H Wynn. 1987. <span>“<a href="https://scholar.google.com/scholar?hl=en&amp;as_sdt=0%2C7&amp;q=Maximum+entropy+sampling&amp;as_ylo=1987&amp;as_yhi=1987&amp;btnG=">Maximum Entropy Sampling</a>.”</span> <em>Journal of Applied Statistics</em> 14 (2): 165–70.
</div>
<div id="ref-Viana2016" class="csl-entry" role="listitem">
Viana, F. 2016. <span>“<a href="https://scholar.google.com/scholar?hl=en&amp;as_sdt=0%2C7&amp;q=A+tutorial+on+Latin+hypercube+design+of+experiments&amp;as_ylo=2016&amp;as_yhi=2016&amp;btnG=">A Tutorial on <span>Latin</span> Hypercube Design of Experiments</a>.”</span> <em>Quality and Reliability Engineering International</em> 32 (5): 1975–85.
</div>
</div>
</section>
<aside id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>This process was illustrated in <a href="tmp_resampling.html#alg-resampling">Algorithm 9.1</a>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>These are described in more detail in <span class="quarto-unresolved-ref">?sec-cls-knn</span><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Other applications may want the points to have properties such as orthogonality, symmetry, etc.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Using Euclidean distance.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</aside>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    const typesetMath = (el) => {
      if (window.MathJax) {
        // MathJax Typeset
        window.MathJax.typeset([el]);
      } else if (window.katex) {
        // KaTeX Render
        var mathElements = el.getElementsByClassName("math");
        var macros = [];
        for (var i = 0; i < mathElements.length; i++) {
          var texText = mathElements[i].firstChild;
          if (mathElements[i].tagName == "SPAN") {
            window.katex.render(texText.data, mathElements[i], {
              displayMode: mathElements[i].classList.contains('display'),
              throwOnError: false,
              macros: macros,
              fleqn: false
            });
          }
        }
      }
    }
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        typesetMath(container);
        return container.innerHTML
      } else {
        typesetMath(note);
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      typesetMath(note);
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../chapters/initial-data-splitting.html" class="pagination-link  aria-label=" &lt;span="" data="" splitting&lt;="" span&gt;"="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Initial Data Splitting</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js" type="text/javascript"></script>
<script type="text/javascript">
(function(d) {
  d.querySelectorAll(".pseudocode-container").forEach(function(el) {
    let pseudocodeOptions = {
      indentSize: el.dataset.indentSize || "1.2em",
      commentDelimiter: el.dataset.commentDelimiter || "//",
      lineNumber: el.dataset.lineNumber === "true" ? true : false,
      lineNumberPunc: el.dataset.lineNumberPunc || ":",
      noEnd: el.dataset.noEnd === "true" ? true : false,
      titlePrefix: el.dataset.algTitle || "Algorithm"
    };
    pseudocode.renderElement(el.querySelector(".pseudocode"), pseudocodeOptions);
  });
})(document);
(function(d) {
  d.querySelectorAll(".pseudocode-container").forEach(function(el) {
    titleSpan = el.querySelector(".ps-root > .ps-algorithm > .ps-line > .ps-keyword")
    titlePrefix = el.dataset.algTitle;
    titleIndex = el.dataset.chapterLevel ? el.dataset.chapterLevel + "." + el.dataset.pseudocodeIndex : el.dataset.pseudocodeIndex;
    titleSpan.innerHTML = titlePrefix + " " + titleIndex + " ";
  });
})(document);
</script>




</body></html>