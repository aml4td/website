---
knitr:
  opts_chunk:
    cache.path: "../_cache/cls-imbalance/"
---

# Class Imbalances {#sec-cls-imbalance}

```{r}
#| label: cls-imbalance-setup
#| include: false

source("../R/_common.R")
# source("../R/_themes_ggplot.R")

# ------------------------------------------------------------------------------

library(tidymodels)
library(sparsevctrs)
library(mirai)
library(gt)
library(probably)
library(patchwork)
library(rules)

# ------------------------------------------------------------------------------
# set options

tidymodels_prefer()
theme_set(theme_bw())
set_options()
daemons(parallel::detectCores())
```


```{r}
#| label: load-data
#| include: false

load("../RData/complaints.RData")

set.seed(836)
complaint_split <- initial_validation_split(complaints, strata = class)
complaint_train <- training(complaint_split)
complaint_test <- testing(complaint_split)
complaint_rs <- validation_set(complaint_split)

train_rate <- mean(complaint_train$class == "no")
rate_by_burro <- 
  complaint_train |> 
  summarize(
    percent = mean(class == "no") * 100,
    number = length(class),
    .by = c(borough)
  ) |> 
  mutate(
    Borough = gsub("_", " ", borough),
    Borough = tools::toTitleCase(Borough)
  ) |> 
  arrange(percent)
```

Examples: churn, click through, diseases (trip test, Parkinsonâ€™s), blood specimen mixups

Focus on two class problems, but an issue for all classes

Prior versus likelihood, posterior

note on time slices to make events

## Underlying mathematical issue

## Imbalances should make us think about what we want from our model

Finding events vs accurate predictions

discussion or relative risk vs absolute risk

This should drive our choice of optimization metric

## Example: NYC Building Complaints


## Accepting the State of Nature 

problem of never predicting the minory class with poor probabilities

Cutoff adjustments

```{r}
#| label: model-setup
#| include: false

cls_mtr <- metric_set(brier_class, roc_auc, pr_auc, kap, mn_log_loss, accuracy, sensitivity, specificity)
ctrl_grid <- control_grid(
  save_pred = TRUE,
  parallel_over = "everything",
  save_workflow = TRUE
)
ctrl_rs <- control_resamples(save_pred = TRUE, save_workflow = TRUE)
```



## Adjustments for Balance

could be balancing the data, weights, metric contributions, or costs

(Better wording)

Cost-sensitive learning

Subsampling

Unrealistic priors

Logistic regression with altered intercept

## Converting Event Times to Binary Classes

graf

## Chapter References {.unnumbered}

