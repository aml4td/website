<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>20&nbsp; Class Imbalances – Applied Machine Learning for Tabular Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/cls-case-study.html" rel="next">
<link href="../chapters/cls-ensembles.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-e0c4a3bc86ed066376318c576df258b1.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<meta name="shinylive:serviceworker_dir" content="..">
<script src="../site_libs/quarto-contrib/shinylive-0.10.6/shinylive/load-shinylive-sw.js" type="module"></script>
<script src="../site_libs/quarto-contrib/shinylive-0.10.6/shinylive/run-python-blocks.js" type="module"></script>
<link href="../site_libs/quarto-contrib/shinylive-0.10.6/shinylive/shinylive.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/shinylive-quarto-css/shinylive-quarto.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-7T996NL20Z"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-7T996NL20Z', { 'anonymize_ip': true});
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar docked quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <a class="flex-grow-1 no-decor" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
          <h1 class="quarto-secondary-nav-title"><span id="sec-cls-imbalances" class="quarto-section-identifier"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Class Imbalances</span></span></h1>
        </a>     
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../"></a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/aml4td/website/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/news.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">News</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/contributing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contributing</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">Introduction</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/whole-game.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">The Whole Game</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Preparation</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/initial-data-splitting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Initial Data Splitting</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/missing-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Missing Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/numeric-predictors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Transforming Numeric Predictors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/categorical-predictors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Working with Categorical Predictors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/embeddings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Embeddings</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/interactions-nonlinear.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Interactions and Nonlinear Features</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">Optimization</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/overfitting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Overfitting</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/resampling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Measuring Performance with Resampling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/grid-search.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Grid Search</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/iterative-search.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Iterative Search</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/feature-selection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Feature Selection</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/comparing-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Comparing Models</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Classification</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/cls-metrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Characterizing Classification Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/cls-linear.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Generalized Linear and Additive Classifiers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/cls-nonlinear.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Complex Nonlinear Boundaries</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/cls-trees.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Classification using Trees and Rules</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/cls-ensembles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Classification Ensembles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/cls-imbalance.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Class Imbalances</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/cls-case-study.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Classification Case Study</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/cls-summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Classification Summary</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Regression</span></span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Characterization</span></span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Finalization</span></span>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-yyopia" id="toc-sec-yyopia" class="nav-link active" data-scroll-target="#sec-yyopia"><span class="header-section-number">20.1</span> Example: Predicting Myopia</a>
  <ul class="collapse">
  <li><a href="#sec-myopia-eda" id="toc-sec-myopia-eda" class="nav-link" data-scroll-target="#sec-myopia-eda"><span class="header-section-number">20.1.1</span> Exploring the Data</a></li>
  </ul></li>
  <li><a href="#sec-imbalance-math" id="toc-sec-imbalance-math" class="nav-link" data-scroll-target="#sec-imbalance-math"><span class="header-section-number">20.2</span> Underlying Mathematical Issue</a></li>
  <li><a href="#sec-imbalance-goals" id="toc-sec-imbalance-goals" class="nav-link" data-scroll-target="#sec-imbalance-goals"><span class="header-section-number">20.3</span> Imbalances Make Us Focus on Our Goals</a></li>
  <li><a href="#sec-imbalance-acceptance" id="toc-sec-imbalance-acceptance" class="nav-link" data-scroll-target="#sec-imbalance-acceptance"><span class="header-section-number">20.4</span> Strategy 1: Accepting the State of Nature</a></li>
  <li><a href="#sec-imblance-correction" id="toc-sec-imblance-correction" class="nav-link" data-scroll-target="#sec-imblance-correction"><span class="header-section-number">20.5</span> Strategy 2: Correcting the Imbalance</a>
  <ul class="collapse">
  <li><a href="#sec-sampling-synthesis" id="toc-sec-sampling-synthesis" class="nav-link" data-scroll-target="#sec-sampling-synthesis"><span class="header-section-number">20.5.1</span> Sampling and Synthesis Techniques</a></li>
  <li><a href="#sec-cost-sensitive-learning" id="toc-sec-cost-sensitive-learning" class="nav-link" data-scroll-target="#sec-cost-sensitive-learning"><span class="header-section-number">20.5.2</span> Cost-Sensitive Learning</a></li>
  </ul></li>
  <li><a href="#sec-prevalence-again" id="toc-sec-prevalence-again" class="nav-link" data-scroll-target="#sec-prevalence-again"><span class="header-section-number">20.6</span> Revenge of the Prevalence</a></li>
  <li><a href="#chapter-references" id="toc-chapter-references" class="nav-link" data-scroll-target="#chapter-references">Chapter References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span id="sec-cls-imbalances" class="quarto-section-identifier"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Class Imbalances</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Examples: churn, click through, diseases (trip test, Parkinson’s), blood specimen mixups</p>
<p>Focus on two class problems, but an issue for all classes</p>
<p>Prior versus likelihood, posterior</p>
<p>note on time slices to make events</p>
<section id="sec-yyopia" class="level2" data-number="20.1">
<h2 data-number="20.1" class="anchored" data-anchor-id="sec-yyopia"><span class="header-section-number">20.1</span> Example: Predicting Myopia</h2>
<p>For demonstration, we’ll use data from the myopia study as described in Section 1.6.6 of <span class="citation" data-cites="hosmer2013applied">Hosmer, Lemeshow, and Sturdivant (<a href="#ref-hosmer2013applied" role="doc-biblioref">2013</a>)</span>. Myopia (i.e., nearsightedness) can be caused by the shape of one’s eye, genetics, and environmental conditions, including the heavy use of computer or television screens. The data are from a medical study running from 1990 to 1995 and contained 302 girls and 316 boys ranging from 5 to 9 years old. These data are from the initial exam and include demographic factors, several physiological measurements of the eye from an ocular examination, and whether either parent is also myopic. The outcome is determined after a five-year follow-up visit. In this study, 81 (13.1%) of children were nearsighted.</p>
<p>To begin, a 3:1 stratified split was used to partition the data into training and testing sets. Stratification was based on the outcome. This results in a training set of 462 children, only 60 of whom are myopic. For the test set, 21 children out of 156 were myopic. Since the training set and the number of events are small, five repeats of 10-fold cross-validation were used with the same stratification strategy. The repeats will help increase the precision of our resampling statistics.</p>
<div class="important-box">
<p>It is critical that the test set reflects the true event rate in the population of interest. While we may change the event rate in the training set during model development, the test set data should be as consistent as possible with reality.</p>
</div>
<p>We’ll conduct some quick exploratory data analysis, then proceed to creating models based on traditional modeling methods, i.e., without making adjustments for class imbalance during model optimization.</p>
<section id="sec-myopia-eda" class="level3" data-number="20.1.1">
<h3 data-number="20.1.1" class="anchored" data-anchor-id="sec-myopia-eda"><span class="header-section-number">20.1.1</span> Exploring the Data</h3>
<p>First, let’s examine the age and sex of the participants. <a href="#fig-myopia-age-sex" class="quarto-xref">Figure&nbsp;<span>20.1</span></a> shows the class percentages for 10 subgroups of the data. The size of the point is based on the number of children in the subgroup, indicating that many of them are 6 years old, while very few are 9 years old. There were no nine-year-old myopic girls in the training set.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-myopia-age-sex" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-myopia-age-sex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="cls-imbalance_files/figure-html/fig-myopia-age-sex-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-myopia-age-sex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.1: Training set rates of myopia by age and sex of the children. The error bars are based on 90% confidence intervals, and the size of the point indicates the number of children in each subgroup.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The points suggest a slight increase in myopia rates among girls, but this is well within the error bars defined by the 90% confidence intervals. Due to the concentration of points in a single age group, it is difficult to determine whether there is an age trend. However, since the slight rate increase for girls is constant from ages six to eight, there is little indication of an interaction between these factors.</p>
<p>Second, do genetics matter? If neither parent is myopic, the rates for their children are low: 1.8% with 90% confidence interval (0.3%, 5.7%). When <em>both</em> parents have the condition, the rate is 21.6% (CI: 15.4%, 28.8%), indicating a strong signal. The effects of single paternal and maternal genetics are in between, with rates 15.3% and 12.6%, respectively, with similar confidence intervals.</p>
<p>The ocular exam yielded five different measurements of the eye. <a href="#fig-myopia-splom" class="quarto-xref">Figure&nbsp;<span>20.2</span></a> shows a scatterplot matrix of pairwise relationships, colored by the outcome class. With one exception, there is little to no correlation between predictors. However, the axial length and the vitreous chamber depth have a high positive correlation. Additionally, most predictors have fairly symmetric distributions, although the spherical equivalent refraction data exhibit a moderately strong right skew. This predictor also shows some raw separation between the classes.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-myopia-splom" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-myopia-splom-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="cls-imbalance_files/figure-html/fig-myopia-splom-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-myopia-splom-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.2: Scatterplot matrix of eye measurements.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="sec-imbalance-math" class="level2" data-number="20.2">
<h2 data-number="20.2" class="anchored" data-anchor-id="sec-imbalance-math"><span class="header-section-number">20.2</span> Underlying Mathematical Issue</h2>
<p>talk about specific literature on logistic models.</p>
<p>We’ll use two predictors in the myopia data to visualize the effects of different techniques. In the upper-left panel of the lower diagonal of <a href="#fig-myopia-splom" class="quarto-xref">Figure&nbsp;<span>20.2</span></a> we see the spherical equivalent refraction and vitreous chamber depth predictor data from the training set, colored by the outcome class. A flexible discriminant analysis model using MARS basis functions was used to model these data. Interactions between hinge functions were allowed, and generalized cross-validation was used to automatically determine the optimal level of model complexity. The model was fit to the training set, and <a href="#fig-myopia-fda" class="quarto-xref">Figure&nbsp;<span>20.3</span></a> shows the class boundary, defined using the 50% probability cutoff. The events (in red) occupy the space to the left of the main data stream. The class boundary does its best to find the optimal partition of the data, but we can see that less than half of the training set events are not to the left of the boundary.</p>
<div id="fig-myopia-fda" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-myopia-fda-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="cls-imbalance_files/figure-html/myopia-fda-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-myopia-fda-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.3: A flexible discriminant fit to the myopia training set. Using the default probability cutoff of 50%, shown as the black contour, 24 of the 60 events are correctly predicted as events.
</figcaption>
</figure>
</div>
<p>Trees provide another example that demonstrates how models can overly focus on the majority class. Since most trees employ a greedy search, the first split is often one that captures the majority of the majority class. As the tree-growing process continues, the minority class becomes less likely to be predicted in the nodes, since <span class="math inline">\(n_{min}\)</span> limits will restrict fine-grained splits. Also, many pruning methods will remove nodes with higher uncertainty, which is often a function of sample size; smaller nodes are more likely to be pruned. When a standard CART model was fit to the data, the rules to each terminal node were:</p>
<ol type="1">
<li>if spherical equivalent refraction <span class="math inline">\(\ge 0.28\)</span> then rate = 6% (<span class="math inline">\(n\)</span> = 382)</li>
<li>if spherical equivalent refraction <span class="math inline">\(\in [0.23, 0.28)\)</span> then rate = 60% (<span class="math inline">\(n\)</span> = 15)</li>
<li>if spherical equivalent refraction <span class="math inline">\(\in [-0.05, 0.23)\)</span> then rate = 33% (<span class="math inline">\(n\)</span> = 46)</li>
<li>if spherical equivalent refraction <span class="math inline">\(\le  -0.05\)</span> then rate = 74% (<span class="math inline">\(n\)</span> = 19)</li>
</ol>
<p>Split 1 was the initial split, and we can see that it captures most of the non-myopic children. The second and third rules attempt to identify spaces where myopic children can be identified, but these two equations are likely the result of overfitting. Regardless, the splits demonstrate how the majority class can dominate the objective function, making the majority class data more likely to be correctly predicted.</p>
<p>This also brings up a pattern that can occur when dealing with class imbalances that is somewhat counterintuitive: models that are <em>less</em> complex tend to work better than highly complex models. In essence, the more models can adapt to the data, the more likely they are to overfit to the majority class. The rule set shown above is a good example. Tree-based models employ a greedy optimization approach to train the model and can carve out small subspaces of predictors to make local predictions. It would be very difficult for a logistic regression to do the same, at least without enormously complex feature engineering. As a result, these simpler models can have sufficient predictive power to be useful, but not so much as to discern minute patterns in the data, thereby correctly predicting the few events and risking overfitting. We’ll see this pattern in the example data, which is admittedly small, but it has also repeated in much larger datasets with class imbalances.</p>
<p>Before moving on to specific techniques, let’s discuss a potential fallacy encountered when there are rare events: correctly predicting the events to the detriment of the overall model goals is often inappropriate.</p>
</section>
<section id="sec-imbalance-goals" class="level2" data-number="20.3">
<h2 data-number="20.3" class="anchored" data-anchor-id="sec-imbalance-goals"><span class="header-section-number">20.3</span> Imbalances Make Us Focus on Our Goals</h2>
<p>Before starting the model development process, it is essential to consider how class balance impacts the project goals. It is often the case that the fact that events rarely occur means that the goal of the model is to identify the precious events in a large dataset (such as in information retrieval), even if it is at the cost of more false positives than we would ordinarily tolerate. In other words, finding the events is of paramount importance, and other considerations, such as interpretability, inference, and explanation of predictions, are not terribly important. This is often the case where the hard class prediction is used in an automated system that only takes the qualitative prediction as input. For example, <span class="citation" data-cites="apm">Kuhn and Johnson (<a href="#ref-apm" role="doc-biblioref">2013</a>)</span> discusses a model used for a high-performance computing grid to route computational jobs to the correct queue based on their execution time. The system only needs to know where to send the job, and measures of uncertainty, such as estimated probabilities for how long the job will take, play no role in the process.</p>
<p>However, it can also be the case that we need to understand why the model works or why a data point was predicted to belong to a specific class. In <span class="quarto-unresolved-ref">?sec-drug-interactions</span>, we’ll discuss a project from drug development where a model is used to estimate the risk of a potential drug causing patient harm. We definitely want to find the events (e.g., problematic drugs), but we also need a good understanding of how certain we are that there is an issue.</p>
<div class="important-box">
<p>In other words, we should not confuse what we will do to deal with extreme frequencies with the idea that we should just care about finding important events.</p>
</div>
<p>These issues are important to consider because, for class imbalances, several approaches can be taken to mitigate the disparity in class frequencies. Some of them can subvert the accuracy of the predicted class probabilities (i.e., result in poor calibration). If we require a model that predicts useful probabilistic outputs, we would avoid some modeling techniques.</p>
<p>Additionally, we should settle on what performance metrics are most important. We may need multiple metrics, including some to measure calibration (Brier scores), overall class separation (ROC curves), and/or the ability to detect events (PR curves). Additionally, knowing how well the hard class predictions work may require attention to sensitivity, specificity, recall, and other metrics.</p>
<p>These are all issues that should be thought about for every modeling project. We emphasize it here because imbalances, especially extreme ones, substantially raise the level of difficulty.</p>
<p>The next two sections will outline two general philosophies when modeling imbalanced data. The first is to accept that the imbalance and model it as-is. We can utilize all the tools and methods previously discussed to create a model driven by performance statistics based on probabilistic predictions, such as log-loss or the area under the receiver operator characteristic curve. Once we have an appropriate model for these criteria, we can focus on how to postprocess the predictions to produce the optimal hard class predictions.</p>
<p>The second philosophy is to circumvent the issue of the imbalance by either removing it or by making the performance metric aware that some training set points (e.g., the events) are more important than others. Both approaches bias the model to be less focused on the majority class.</p>
<p>Both philosophies have advantages and disadvantages. Generally, if finding the events is the overriding goal, the second philosophy will likely be the best choice.</p>
</section>
<section id="sec-imbalance-acceptance" class="level2" data-number="20.4">
<h2 data-number="20.4" class="anchored" data-anchor-id="sec-imbalance-acceptance"><span class="header-section-number">20.4</span> Strategy 1: Accepting the State of Nature</h2>
<p>In this case, we’ll try to build ML models while generally ignoring the imbalance. The idea is that we should initially focus on optimizing metrics based on class probability estimates, such as the Brier score, cross-entropy, or the areas under the ROC or PR curves. Once we have a model with good calibration and/or discrimination, we can then focus on making the best hard class predictions. We’ll show the advantages and disadvantages of using this strategy.</p>
<p>To get started, we’ll fit a subset of models to these data and generally follow the process outlined in the previous chapters. There is little to no preprocessing required for these models. There is a single pair of highly correlated predictors, but that will be handled by the model in situations where multicorrelation is a concern.</p>
<p>A set of five models was tested. First, a regularized logistic regression was used with glmnet penalties. The predictors included main effects and all two-factor interactions. Penalty values ranging from 10<sup>-4</sup> to 10<sup>-0.6</sup> were evaluated with four mixtures that ranged from 0% to 100% Lasso. A regular grid of 72 candidates was used to optimize these parameters<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<p>Single-layer neural networks were evaluated and were tuned over:</p>
<div class="columns">
<div class="column" style="width:50%;">
<ul>
<li>The number of hidden units (2 to 50).</li>
<li>The L<sub>2</sub> penalty (10<sup>-10</sup> to 10<sup>-1</sup>).</li>
<li>The learning rate (10<sup>-4</sup> to 10<sup>-1</sup>).</li>
</ul>
</div><div class="column" style="width:50%;">
<ul>
<li>The batch size (8 to 256 samples).</li>
<li>AdamW momentum (0.8 to 0.99).</li>
</ul>
</div>
</div>
<p>SGD via AdamW was used to optimize the model for up to 100 epochs, with early stopping after 5 consecutive poor results. ReLU activation was used.</p>
<p>Boosted trees (via light GBM) were also trained for up to 1,000 iterations with early stopping after 5 bad iterations. The model was tuned over:</p>
<div class="columns">
<div class="column" style="width:50%;">
<ul>
<li>Tree depth (1 to 15 splits).</li>
<li>Amount of data needed for further splitting (2 to 40 samples).</li>
</ul>
</div><div class="column" style="width:50%;">
<ul>
<li>The learning rate (10<sup>-3</sup> to 10<sup>-0.5</sup>).</li>
<li><span class="math inline">\(m_{try}\)</span> (1 to 16 predictors).</li>
</ul>
</div>
</div>
<p>Additionally, random forests with 2,000 classification trees were tuned over:</p>
<ul>
<li>Amount of data needed for further splitting (2 to 40 samples).</li>
<li><span class="math inline">\(m_{try}\)</span> (1 to 16 predictors)..</li>
</ul>
<p>Finally, a RuleFit model was optimized over:</p>
<div class="columns">
<div class="column" style="width:50%;">
<ul>
<li>The number of boosting iterations (5 to 100)</li>
<li>Tree depth (2 to 4 splits).</li>
<li>Amount of data needed for further splitting (2 to 10 samples).</li>
</ul>
</div><div class="column" style="width:50%;">
<ul>
<li>The learning rate (10<sup>-10</sup> to 10<sup>0</sup>).</li>
<li>Proportional <span class="math inline">\(m_{try}\)</span> (10% to 100%).</li>
<li>The L<sub>1</sub> penalty (10<sup>-10</sup> to 10<sup>0</sup>).</li>
</ul>
</div>
</div>
<p>Apart from the logistic regression, a space-filling design of 25 candidates was used for optimization.</p>
<p><a href="#fig-myopia-plain-roundup" class="quarto-xref">Figure&nbsp;<span>20.4</span></a> visualizes the results across and within models. Each point represents a candidate within a model. These are ranked by their resampled Brier score and are ordered accordingly. The vertical lines help highlight where the best candidate was located in the ranking. Interestingly, the logistic regression and RuleFit models had the best results and were very similar (see discussion below). The other three models had both good and bad performance across their candidates, but, in terms of model calibration, did not do as well. This may be due to the fact that this data set is better served by simpler models; the added complexity generated by large tree ensembles and neural networks is likely overfitting to some degree.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-myopia-plain-roundup" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-myopia-plain-roundup-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="cls-imbalance_files/figure-html/fig-myopia-plain-roundup-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-myopia-plain-roundup-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.4: Cross-validated Brier scores for different modeling approaches without adjustments for class imbalance. The dashed vertical lines indicate the highest-ranked candidate for each model.
</figcaption>
</figure>
</div>
</div>
</div>
<p>While the Rulefit and logistic regressions had the smallest Brier scores, their respective best candidates have issues. For the RuleFit model, the maximum estimated probability of a patient being myopic is 71.5% across all of the assessment sets. While the values are well-calibrated within the observed data range, this upper limit of probability is probably too small to be the final model. We would expect at least one of the held-out predictions to be closer to one when the patient is truly myopic. We also do not have a clear sense of how well-calibrated the predictions are when values are closer to one.</p>
<p>TODO: problem of never predicting the minor class with poor probabilities</p>
<p>For the regularized logistic model, <a href="#fig-myopia-logistic" class="quarto-xref">Figure&nbsp;<span>20.5</span></a> illustrates the relationship between the tuning parameters and the Brier score. We can see that while the numerically best results are to use 100% Lasso regularization with a penalty of 10<sup>-2</sup>, there are several other combinations with nearly equivalent metrics. The model fitted on the entire training set could have a maximum of 136 model coefficients (apart from the intercept) since there are 16 main effects and 120 possible two-way interactions. However, the Lasso model can remove predictors, and the fitted model contains only 1 main effect and 16 interactions. For a model used purely for prediction, this is not a terrible situation. However, the lack of main effects is troubling since there are interaction terms in the model with no corresponding main effects. This is inconsistent with the heredity principle discussed in <a href="interactions-nonlinear.html#sec-interactions-principles" class="quarto-xref"><span>Section 8.1.1</span></a> and suggests that these interactions are unlikely to be real.</p>
<p>To sidestep this issue, we can choose a different tuning parameter candidate. If we use <em>no</em> Lasso regularization, the model will contain all parameters, but regularizes some of them to be close to zero. This would ensure that all of the interaction terms have corresponding main effects in the model. Taking this approach, the penalty associated with the smallest Brier score is 10<sup>-0.8</sup>. For this model, the resampling estimate of the Brier score is 0.0864%, which is 2.8 worse than the original choice, but still very good when compared to the other models. We’ll use this candidate going forward.</p>
<p>Additionally, <a href="#fig-myopia-logistic" class="quarto-xref">Figure&nbsp;<span>20.5</span></a> shows some diagnostics for the logistic regression. These plots are constructed by obtaining the assessment set predictions across the 50 resamples. Note that since repeated cross-validation was used, each training set point has five replicates in the held-out data, totaling 23,100 rows across all resamples. To create the calibration and ROC curves, the five predictions for each training set point are averaged so that we have a set of 462 rows of predictions. Please note that these are approximate and may differ from the performance statistics generated by resampling. For example, <a href="#fig-myopia-logistic" class="quarto-xref">Figure&nbsp;<span>20.5</span></a> shows a single curve while the resampled ROC AUC is the average of 50 ROC curves created with 10% of the training set. Despite this, the visualizations can help us characterize the quality of the fit and detect any significant issues in the predictions.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-myopia-logistic" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-myopia-logistic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="cls-imbalance_files/figure-html/fig-myopia-logistic-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-myopia-logistic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.5: Results of the logistic regression model optimization (without adjustments for the class imbalance). The top plot shows the performance profile for the two tuning parameters. Underneath are the calibration and ROC curves. The solid blue point on the ROC curve corresponds to the default cutoff. The pooled averaged holdout predictions were used to compute these visualizations.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The calibration curve is generally good, except for the upper end, where it indicates that the model underpredicts the probability of myopia. There is also a region around an x-axis point where events occur at a rate of 60%, and the probabilities are slightly overpredicted. All in all, though, the calibration curve is impressive.</p>
<p>The ROC curve is symmetric and fairly unremarkable. The visualization shows that the default 50% threshold for converting the probabilities to hard “yes/no” predictions is somewhat problematic. The sensitivity for this cutpoint is very poor (16.4%) while the specificity is exquisite (98.2%). This is fairly common for class imbalances. The model performs significantly better where the data are more abundant, and since most participants in the study are not myopic, high specificity is more easily achieved.</p>
<p>We quantified performance for these models using a variety of methods. <a href="#tbl-plain-metrics" class="quarto-xref">Table&nbsp;<span>20.1</span></a> shows several statistics for both hard and soft prediction types. When assessing class probability estimates, the Brier scores for each model are all acceptably low, and most areas under the ROC curves have objectively large values. The areas under the precision-recall curves are mediocre, with the largest possible value being 1.0 and the worst value is 0.13.</p>
<div class="columns">
<div class="column" style="width:5%;">

</div><div class="column" style="width:90%;">
<div id="tbl-plain-metrics" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<div aria-describedby="tbl-plain-metrics-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="leuxeszzit" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#leuxeszzit table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#leuxeszzit thead, #leuxeszzit tbody, #leuxeszzit tfoot, #leuxeszzit tr, #leuxeszzit td, #leuxeszzit th {
  border-style: none;
}

#leuxeszzit p {
  margin: 0;
  padding: 0;
}

#leuxeszzit .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#leuxeszzit .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#leuxeszzit .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#leuxeszzit .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#leuxeszzit .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#leuxeszzit .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#leuxeszzit .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#leuxeszzit .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#leuxeszzit .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#leuxeszzit .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#leuxeszzit .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#leuxeszzit .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#leuxeszzit .gt_spanner_row {
  border-bottom-style: hidden;
}

#leuxeszzit .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#leuxeszzit .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#leuxeszzit .gt_from_md > :first-child {
  margin-top: 0;
}

#leuxeszzit .gt_from_md > :last-child {
  margin-bottom: 0;
}

#leuxeszzit .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#leuxeszzit .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#leuxeszzit .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#leuxeszzit .gt_row_group_first td {
  border-top-width: 2px;
}

#leuxeszzit .gt_row_group_first th {
  border-top-width: 2px;
}

#leuxeszzit .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#leuxeszzit .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#leuxeszzit .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#leuxeszzit .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#leuxeszzit .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#leuxeszzit .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#leuxeszzit .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#leuxeszzit .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#leuxeszzit .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#leuxeszzit .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#leuxeszzit .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#leuxeszzit .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#leuxeszzit .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#leuxeszzit .gt_left {
  text-align: left;
}

#leuxeszzit .gt_center {
  text-align: center;
}

#leuxeszzit .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#leuxeszzit .gt_font_normal {
  font-weight: normal;
}

#leuxeszzit .gt_font_bold {
  font-weight: bold;
}

#leuxeszzit .gt_font_italic {
  font-style: italic;
}

#leuxeszzit .gt_super {
  font-size: 65%;
}

#leuxeszzit .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#leuxeszzit .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#leuxeszzit .gt_indent_1 {
  text-indent: 5px;
}

#leuxeszzit .gt_indent_2 {
  text-indent: 10px;
}

#leuxeszzit .gt_indent_3 {
  text-indent: 15px;
}

#leuxeszzit .gt_indent_4 {
  text-indent: 20px;
}

#leuxeszzit .gt_indent_5 {
  text-indent: 25px;
}

#leuxeszzit .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#leuxeszzit div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-bootstrap="false">
<colgroup>
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="gt_col_headings gt_spanner_row header">
<th rowspan="2" id="Model" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Model</th>
<th colspan="4" id="Hard Class Prediction Metrics" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" scope="colgroup"><div class="gt_column_spanner">
Hard Class Prediction Metrics
</div></th>
<th colspan="3" id="Probability Prediction Metrics" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" scope="colgroup"><div class="gt_column_spanner">
Probability Prediction Metrics
</div></th>
</tr>
<tr class="gt_col_headings even">
<th id="Accuracy" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Accuracy</th>
<th id="Sensitivity" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Sensitivity</th>
<th id="Specificity" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Specificity</th>
<th id="Kappa" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Kappa</th>
<th id="ROC-AUC" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">ROC AUC</th>
<th id="PR-AUC" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">PR AUC</th>
<th id="Brier-Score" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Brier Score</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="Model">Logistic (glmnet)</td>
<td class="gt_row gt_right" headers="Accuracy">87.7%</td>
<td class="gt_row gt_right" headers="Sensitivity">16.4%</td>
<td class="gt_row gt_right" headers="Specificity">98.2%</td>
<td class="gt_row gt_right" headers="Kappa">0.197</td>
<td class="gt_row gt_right" headers="ROC AUC">0.849</td>
<td class="gt_row gt_right" headers="PR AUC">0.536</td>
<td class="gt_row gt_right" headers="Brier Score">0.0864</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Model">Neural Network</td>
<td class="gt_row gt_right" headers="Accuracy">86.3%</td>
<td class="gt_row gt_right" headers="Sensitivity">12.4%</td>
<td class="gt_row gt_right" headers="Specificity">97.3%</td>
<td class="gt_row gt_right" headers="Kappa">0.125</td>
<td class="gt_row gt_right" headers="ROC AUC">0.800</td>
<td class="gt_row gt_right" headers="PR AUC">0.401</td>
<td class="gt_row gt_right" headers="Brier Score">0.0980</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Model">Random Forest</td>
<td class="gt_row gt_right" headers="Accuracy">87.2%</td>
<td class="gt_row gt_right" headers="Sensitivity">21.4%</td>
<td class="gt_row gt_right" headers="Specificity">96.9%</td>
<td class="gt_row gt_right" headers="Kappa">0.236</td>
<td class="gt_row gt_right" headers="ROC AUC">0.852</td>
<td class="gt_row gt_right" headers="PR AUC">0.501</td>
<td class="gt_row gt_right" headers="Brier Score">0.0889</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Model">Boosted Tree</td>
<td class="gt_row gt_right" headers="Accuracy">87.2%</td>
<td class="gt_row gt_right" headers="Sensitivity">17.3%</td>
<td class="gt_row gt_right" headers="Specificity">97.6%</td>
<td class="gt_row gt_right" headers="Kappa">0.200</td>
<td class="gt_row gt_right" headers="ROC AUC">0.864</td>
<td class="gt_row gt_right" headers="PR AUC">0.508</td>
<td class="gt_row gt_right" headers="Brier Score">0.0884</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Model">RuleFit</td>
<td class="gt_row gt_right" headers="Accuracy">87.7%</td>
<td class="gt_row gt_right" headers="Sensitivity">11.1%</td>
<td class="gt_row gt_right" headers="Specificity">99.0%</td>
<td class="gt_row gt_right" headers="Kappa">0.141</td>
<td class="gt_row gt_right" headers="ROC AUC">0.869</td>
<td class="gt_row gt_right" headers="PR AUC">0.541</td>
<td class="gt_row gt_right" headers="Brier Score">0.0875</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-tbl" id="tbl-plain-metrics-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;20.1: Resampled performance metrics for the best candidates across different models. The models were optimized based on the Brier score.
</figcaption>
</figure>
</div>
</div><div class="column" style="width:5%;">

</div>
</div>
<p>The hard class predictions in <a href="#tbl-plain-metrics" class="quarto-xref">Table&nbsp;<span>20.1</span></a> use the default 50% probability cutoff. A few of the models have accuracies that are larger than the rate that the majority class occurs in the training set (87%). The Kappa statistics indicate a significant signal in the models for predicting qualitative class membership. However, with this cutoff, the model is effectively useless at predicting which people are myopic, as the best possible sensitivity is 21.4%.</p>
<p>If we are satisfied with the model’s ability to discriminate between classes (as evidenced by the ROC curve) and that the probabilities are sufficiently calibrated, we can address the sensitivity problem by selecting an appropriate probability threshold. As with most optimization problems, we require an objective function to make the best decision regarding this tuning parameter. There are a few ways we can approach the problem:</p>
<ol type="1">
<li>Given what we know about how the model will be used, we could define specific costs for false negatives and false positives (with correctly predicted classes having zero cost). Using these values, we can choose a threshold that minimizes the cost of the decision. This is similar to a weighted Kappa approach, except the weights would not be symmetric.</li>
<li>Seek a constrained optimization. For example, we can try to maximize the sensitivity under the constraint that the specificity is at an acceptable value. The ROC curve provides the substrate for these calculations, as it includes sensitivity and specificity for various thresholds in the data.</li>
<li>Optimize an existing composite score that captures the right balance of sensitivity and specificity. The Matthews correlation coefficient and F-statistics are examples of such metrics.</li>
<li>Use a multiparameter optimization method, such as desirability functions from <a href="cls-metrics.html#sec-cls-multi-objectives" class="quarto-xref"><span>Section 15.10</span></a>, to define a jointly acceptable result (i.e., overall desirability). This would enable us to consider multiple performance metrics, as well as other variables, in the decision-making process.</li>
</ol>
<p>We’ll focus on the first two options.</p>
<p>To choose the threshold using a custom cost metric (the first option in the list above), we would have to determine an appropriate cost structure for false positives and false negatives, usually based on the consequences of either error. For our myopia example, this is a somewhat subjective choice that depends on some context-specific rationale. In other cases, the costs might be analytically calculated as a function of monetary costs. <a href="#fig-class-cost" class="quarto-xref">Figure&nbsp;<span>20.6</span></a> shows examples of cost curves if the false positive cost is fixed at 1.0 and the cost of a false negative varies in severity. The y-axis is the mean of the cost values averaged across the 50 assessment sets.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-class-cost" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-class-cost-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="cls-imbalance_files/figure-html/fig-class-cost-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-class-cost-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.6: Cost curves when the cost of a correct prediction is zero, the cost of a false positive is 1.0, and the cost of a false negative varies.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The figure shows that increasing the cost of incorrectly predicting the events yields increasingly smaller thresholds. This is due to classifying more points as events, regardless of their actual class. The cost metric is punished less by incorrectly predicted non-events, so the overall cost statistic decreases substantially in the curves with higher false negative costs.</p>
<div class="important-box">
<p>It is important to realize that this strategy only optimizes the probability threshold. The model fit (e.g., slope and intercept parameter estimates) has not been affected by the cost function. In the next section, we will consider costs to the objective function that the model uses during training.</p>
</div>
<p>Moving on to constrained optimization, when choosing a threshold using an ROC curve, an immediate question arises: “Which data should be used to compute the ROC curve?” <em>Preferably</em>, the cutoff selection should use different data than the data used to fit the model. For example, diagnostic tests that require approval from a government agency (e.g., the Food and Drug Administration in the US) require a different data set to set the threshold. However, this may not be feasible if there is not an abundance of data or the resources to acquire such data. If we can’t hold out another data set, we can use the assessment sets generated during resampling<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. There are at least two different approaches.</p>
<ul>
<li><p><strong>Option 2A - <em>post hoc</em> pooling</strong>: After we have resampled our model configurations, we can pool the assessment set predictions for the best candidate. This ROC curve is computed based on the overall existing class probability estimate values. This approach generated the visualizations in <a href="#fig-myopia-logistic" class="quarto-xref">Figure&nbsp;<span>20.5</span></a>.</p></li>
<li><p><strong>Option 2B - threshold tuning</strong>: During model tuning, we treat the probability threshold as a tuning parameter and include it in the grid search. For each threshold in the grid, conditional on any other tuning parameters, we have resampling estimates for sensitivity and specificity. These points are then used to create an ROC curve.</p></li>
</ul>
<p>The primary difference between these approaches lies in data usage: do we compute one large ROC curve from pooled data or an ROC curve from resampled statistics? Statistically, the latter is more appropriate, but either might produce acceptable results.</p>
<p>Note that there are a few options when we treat the threshold as a tuning parameter. A one-stage approach would include the threshold along with any other tuning parameters and use a single grid for all<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. However, recall that the choice of this parameter does not affect any probability-based metrics, such as the Brier score, log-loss, or the area under the ROC curve. Instead, we could use a two-stage approach where the non-threshold parameters are optimized to find their best results, and then we can use a one-dimensional grid to find the best threshold (based on metrics appropriate for hard class predictions). We took this approach here: 20 threshold values ranging from 2% to 40% defined the second-stage grid.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-myopia-two-roc" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-myopia-two-roc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="cls-imbalance_files/figure-html/fig-myopia-two-roc-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-myopia-two-roc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.7: Two approaches for optimizing the probability threshold via the ROC curve. Both curves use the regularized logistic regression’s resampling results.
</figcaption>
</figure>
</div>
</div>
</div>
<p>For the logistic regression model, <a href="#fig-myopia-two-roc" class="quarto-xref">Figure&nbsp;<span>20.7</span></a> shows the ROC curves for both schemes. The curves significantly overlap for these data. Note that the curve associated with a second-stage grid contains 20 unique points since it is based on the values used in our second-stage grid. The curve for the <em>post hoc</em> pooling method has 462 points, which represents how many unique predicted probabilities are contained in the <em>post hoc</em> data pool.</p>
<p>Using either method for composing the ROC tool provides us with a tool to make trade-offs between sensitivity and specificity. For example, if we want to maximize sensitivity on the condition that specificity is at least 80%, the curve produced by threshold tuning indicates that the cutoff should be 16%. The estimated statistics associated with this value are a sensitivity of 75.7% and a specificity of 81.6%.</p>
<p>This overall approach involves finding a suitable ML model that does not allow class imbalance to alter our methodology, while deferring cutoff selection until the end of the process. This approach can lead to a well-calibrated model that appropriately classifies new samples. The downside becomes apparent when trying to explain individual results to the model’s consumers.</p>
<p>For our myopia example, suppose we make a prediction for a patient where the probability of myopia is estimated to be 20%. The conversation with the patient might sound something like</p>
<blockquote class="blockquote">
<p>“We estimate that your child has a 20% chance of being severely nearsighted and, based on this, we would give them a diagnosis of myopia.”</p>
</blockquote>
<p>It is natural for someone to find the diagnosis counterintuitive since they are probably comparing the probability to the natural 50% threshold. It might lead the parent to ask:</p>
<blockquote class="blockquote">
<p>“That probability seems pretty low to make that diagnosis. Is that a mistake?”</p>
</blockquote>
<p>The non-technical response could be:</p>
<blockquote class="blockquote">
<p>“We think that the diagnosis is appropriate because the overall chances of being myopic are low, and we have determined that our cutoff for making the diagnosis (16%) gives us the most effective diagnoses.”</p>
</blockquote>
<p>Of course, this is paraphrasing, but the hypothetical conversation does illustrate the potential confusion.</p>
<p>This seeming disconnect can become worse as the prevalence becomes smaller. For very rare events (i.e., &lt; 5%), the cutoff associated with the sensitivity-specificity trade-off can be very small, perhaps less than 1%. This is the price paid for having probability estimates that are consistent with the rate at which the event occurs in the wild.</p>
</section>
<section id="sec-imblance-correction" class="level2" data-number="20.5">
<h2 data-number="20.5" class="anchored" data-anchor-id="sec-imblance-correction"><span class="header-section-number">20.5</span> Strategy 2: Correcting the Imbalance</h2>
<p>In the previous section, the only operation used to account for the small minority class was to optimize the probability threshold <em>after</em> the model had been chosen. In this section, we’ll consider several methods for actively addressing the imbalance during model optimization. The two primary classes of techniques are:</p>
<ul>
<li>Changing the composition of the training set data.</li>
<li>Upweighting the minority class’s effect on the objective function.</li>
</ul>
<p>As we’ll see, these can have a profound effect on the class probability estimates (both good and bad). These techniques are also most effective when the primary goal of the model is to identify events in new data.</p>
<section id="sec-sampling-synthesis" class="level3" data-number="20.5.1">
<h3 data-number="20.5.1" class="anchored" data-anchor-id="sec-sampling-synthesis"><span class="header-section-number">20.5.1</span> Sampling and Synthesis Techniques</h3>
<p>One strategy for addressing a class imbalance is to eliminate it in the training set by adding or removing rows, depending on the class. A “sampling” method would remove existing rows from the data (likely from the majority class) to even the class frequencies. The removal may be random or based on characteristics of the existing data. Other sampling methods can oversample existing data. “Synthesis” methods invent new rows of the data in a way that makes them similar to or consistent with existing examples from the same class.</p>
<p>Regardless of the method used, note that rebalancing occurs only on the data being used to train the model. If we are within a resampling loop, the analysis sets are affected, but the assessment sets are not. If we are going to fit a model to the entire data set, the training set is rebalanced, but the test set<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> are unaffected. The reason for this is that the data used to measure how well the models work should be drawn from the same population as the data the model will eventually be used to predict. Rebalancing tools deliberately bias the sample to be unlike the population being predicted.</p>
<p>Note that all the techniques mentioned here should be considered as yet another preprocessing method. As such, it is in the interest of the modeler to resample the models and include these steps within the resampling process. It would be inappropriate to apply a technique such as downsampling and then resample the data. Since these methods involve randomness, we need to account for it in our performance statistics.</p>
<p>We’ll describe each technique in the context of its use to modify the training set (or the analysis set when resampling). However, for models that resample the data, such as stochastic gradient boosting or random forests, these tools could also be applied within each resample. For example, our first technique described below, <em>downsamples</em> the majority class to reduce its size. A random forest model could do the same by using a stratified bootstrap sample that produces the sample number of data points for each class <span class="citation" data-cites="chen2004using">(<a href="#ref-chen2004using" role="doc-biblioref"><strong>chen2004using?</strong></a>)</span>. <span class="citation" data-cites="chawla2003smoteboost">(<a href="#ref-chawla2003smoteboost" role="doc-biblioref"><strong>chawla2003smoteboost?</strong></a>)</span> and <span class="citation" data-cites="galar2011review">(<a href="#ref-galar2011review" role="doc-biblioref"><strong>galar2011review?</strong></a>)</span> provide similar examples. This is highly dependent on the implementation, but it might be advantageous because the sampling/synthesis methods would be applied repeatedly, which can reduce model variance by exposing it to more unique data points.</p>
<section id="sec-downsampling" class="level4" data-number="20.5.1.1">
<h4 data-number="20.5.1.1" class="anchored" data-anchor-id="sec-downsampling"><span class="header-section-number">20.5.1.1</span> Downsampling</h4>
<p>This approach is straightforward: every class with more data than the minority class is randomly sampled, ensuring that all classes have the same number of training set points. The minority class stays the same. For our myopia data, the majority class is randomly reduced from 462 to 81 patients. <a href="#fig-myopia-subsampling" class="quarto-xref">Figure&nbsp;<span>20.8</span></a> show examples for the two predictor subset including how the FDA fit changes with the reduced data set. We can see that the class boundary is slightly more simplistic than <a href="#fig-myopia-fda" class="quarto-xref">Figure&nbsp;<span>20.3</span></a> but has shifted to the right, capturing more events with the default 50% cutoff (at the expense of increased false positives).</p>
<div id="fig-myopia-subsampling" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-myopia-subsampling-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="figure-content">
<pre class="shinylive-r" data-engine="r"><code>#| '!! shinylive warning !!': |
#|   shinylive does not work in self-contained HTML documents.
#|   Please set `embed-resources: false` in your metadata.
#| label: fig-subsampling
#| out-width: "80%"
#| viewerHeight: 600
#| standalone: true

library(shiny)
library(bslib)
library(ggplot2)
library(dplyr)
library(munsell)
library(scales)

source("https://raw.githubusercontent.com/aml4td/website/main/R/shiny-setup.R")
# source("https://raw.githubusercontent.com/aml4td/website/main/R/shiny-sa.R")

ui &lt;- page_fillable(
  theme = bs_theme(bg = "#fcfefe", fg = "#595959"),
  padding = "1rem",
  layout_columns(
    fill = FALSE,
    col_widths = breakpoints(sm = c(-1, 10, -1)),
    column(
      width = 10,
      selectInput(
        inputId = "method",
        label = " ",
        choices = c(
          "Downsampled",
          "SMOTE",
          "ROSE",
          "Near Miss",
          "Adaptive Synthetic Algorithm",
          "Tomek"
        ),
        selected = c("Downsampled")
      )
    )
  ),
  as_fill_carrier(plotOutput("plot")),
  br(),
  textOutput("text")
)

server &lt;- function(input, output) {
  load(url(
    "https://raw.githubusercontent.com/aml4td/website/main/RData/imbalanced_sampled.RData"
  ))

  xrng &lt;- range(imbalanced_sampled$spherical_equivalent_refraction)
  yrng &lt;- range(imbalanced_sampled$vitreous_chamber_depth)

  orig &lt;- imbalanced_sampled %&gt;%
    dplyr::filter(Data == "Original")

  output$plot &lt;-
    renderPlot(
      {
        dat &lt;- imbalanced_sampled %&gt;%
          dplyr::filter(Data == input$method) |&gt;
          dplyr::bind_rows(orig) |&gt;
          dplyr::mutate(
            Data = factor(Data, levels = c("Original", input$method))
          )

        grid &lt;- imbalanced_grid %&gt;%
          dplyr::filter(Data == input$method) |&gt;
          dplyr::select(-Data) |&gt;
          filter(!is.na(.pred_yes))
        p &lt;-
          dat |&gt;
          ggplot(
            aes(
              spherical_equivalent_refraction,
              vitreous_chamber_depth
            )
          ) +
          geom_point(
            aes(
              col = class,
              pch = class
            ),
            cex = 1.6,
            alpha = 2 / 3
          ) +
          facet_wrap(~Data) +
          coord_fixed(ratio = 1.4, xlim = xrng, ylim = yrng)

        p &lt;- p +
          theme(legend.position = "top") +
          scale_color_brewer(drop = FALSE, palette = "Set1", direction = 01) +
          theme_light_bl()

        p &lt;-
          p +
          geom_tile(data = grid, aes(fill = .pred_yes), alpha = .1) +
          geom_contour(
            data = grid,
            aes(z = .pred_yes),
            breaks = 1 / 2,
            col = "black"
          ) +
          scale_fill_gradient2(
            low = "#377EB8",
            mid = "white",
            high = "#E41A1C",
            midpoint = 0.5
          ) +
          labs(
            x = "spherical equivalent refraction",
            y = "vitreous chamber depth",
            fill = "Probability"
          )
        print(p)
      },
      res = 100
    )
  
  output$text &lt;-
    renderText(
      paste(
        "Using the default 50% threshold, this method correctly identified", 
        imbalanced_hits[input$method], 
        "truly myopic subjects (out of 60).") 
    )
}

app &lt;- shinyApp(ui = ui, server = server)
app</code></pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-myopia-subsampling-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.8: The effect of a few sampling and synthesis techniques on two of the predictors in the myopia training set. The class boundary is based on a 50% probability cutoff.
</figcaption>
</figure>
</div>
<p>Besides rebalancing, the advantage of downsampling is that models can be trained faster. The downside is that important information might be lost in the majority class(es) due to random sampling. We are diminishing the influence of the non-minority classes and creating a smaller training set. Another effect of this is that our models will tend to be more simplistic, as the data cannot support excessive complexity.</p>
<p>Can also be used inside of SGB and RF</p>
</section>
<section id="sec-upsampling" class="level4" data-number="20.5.1.2">
<h4 data-number="20.5.1.2" class="anchored" data-anchor-id="sec-upsampling"><span class="header-section-number">20.5.1.2</span> Upsamping</h4>
<p>Upsampling will create random replicates of the majority class(es) so that all classes have the same frequency in the training set. This increases the training set, sometimes to orders of magnitude larger, so training time can become excessive for some models. There is also the issue of having a potentially large number of replicates for each minority<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> class value in the original training set. For example, for models such as random forest that use bootstrap samples to fit models, we could have even more replicates of these data points. Another complication occurs when a model, such as <em>K</em>-nearest neighbors, is used; all of the nearest neighbors might be the same data point.</p>
<p>Upsampling is probably the least used of these techniques do to these issues.</p>
</section>
<section id="sec-smote" class="level4" data-number="20.5.1.3">
<h4 data-number="20.5.1.3" class="anchored" data-anchor-id="sec-smote"><span class="header-section-number">20.5.1.3</span> SMOTE</h4>
<p>The Synthetic Minority Oversampling Technique (SMOTE) is a method that combines random sampling with the creation of novel data points, which are fusions and/or perturbations of existing points. There are a few flavors of this method, but we’ll focus on the original technique by REF where all predictors are required to be numeric.</p>
<p>For each data point in the minority class, compute its K-nearest neighbors. The create a new artificial data point, we select a minority class point at random (<span class="math inline">\(\boldsymbol{x}_i\)</span>) as well as one of its neighbors. For each predictor, we compute the difference between the original data point and its chosen neighbor (call this <span class="math inline">\(\delta_j\)</span> for predictor <span class="math inline">\(j\)</span>). For each predictor, we compute a uniform random number <span class="math inline">\(u_j \sim U(0, 1)\)</span> and modify the original point as <span class="math inline">\(x^*_{ij} = x_{ij} + u_j\delta_j\)</span>. Essentially, SMOTE generates a hyperrectangle between the selected point and its chosen neighbor, and then randomly places the new sample within the hyperrectangle.</p>
<p><a href="#fig-smote-rose" class="quarto-xref">Figure&nbsp;<span>20.9</span></a> illustrates the process using a selected point (large red circle) in the north-west portion of the previously shown predictor space. A neighbor was selected below and to the right of the original point (large red square). The dotted lines show the area where newly synthesized points can be placed, and twenty examples are shown (open circles).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-smote-rose" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-smote-rose-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="cls-imbalance_files/figure-html/fig-smote-rose-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-smote-rose-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.9: Demonstrations of how SMOTE and ROSE synthesize new samples. The chosen point is the large red circle, and SMOTE’s selected nearest neighbor is the large red square. The ellipses in panel (b) represent Gaussian probability contours based on the kernel density estimate. Twenty points are synthesized for each panel.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Note that SMOTE does not center the new samples around the original point; they can only be adjacent to it, since newly created data points must lie between it and the neighbor. This has the effect of clumping or clustering points to some degree. This can be seen in <a href="#fig-myopia-sampling" class="quarto-xref">Figure&nbsp;<span>20.11</span></a> where there are gaps in the minority class distribution where no minority class data reside. This can be resolved by increasing the number of neighbors, but adding too many would lead to overlap in predictor distributions for each class. One could tune the number of neighbors, but it may not produce a clear winner for this parameter.</p>
<p>note overfitting in <a href="#fig-myopia-sampling" class="quarto-xref">Figure&nbsp;<span>20.11</span></a></p>
<p>generalizations</p>
</section>
<section id="sec-rose" class="level4" data-number="20.5.1.4">
<h4 data-number="20.5.1.4" class="anchored" data-anchor-id="sec-rose"><span class="header-section-number">20.5.1.4</span> ROSE</h4>
</section>
<section id="sec-knn-sampling" class="level4" data-number="20.5.1.5">
<h4 data-number="20.5.1.5" class="anchored" data-anchor-id="sec-knn-sampling"><span class="header-section-number">20.5.1.5</span> Neighbor-Based Sampling</h4>
<p><span class="citation" data-cites="mani2003knn">(<a href="#ref-mani2003knn" role="doc-biblioref"><strong>mani2003knn?</strong></a>)</span> describe tools for undersampling the majority class using nearest neighbors. Their idea is to find points to remove based on how close (or far) they are from the minority class data. They outlined three procedures that use the name “NearMiss”. We’ll briefly describe each in turn and use a small “toy” data set to outline the details. These data are shown in <a href="#fig-near-miss" class="quarto-xref">Figure&nbsp;<span>20.10</span></a>. There are 10 data points in the simulated training. The first 6 samples are from the majority class, and the next 4 samples labeled are from the minority data. Each of the three NearMiss methods uses a <span class="math inline">\(4 \times 6\)</span> distance matrix that captures the distances between the majority and minority class data (there is no need to find the neighbors within these two groups).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-near-miss" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-near-miss-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="cls-imbalance_files/figure-html/fig-near-miss-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-near-miss-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.10: Data to demonstrate Near Miss and Tomek Link methods.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The technique called “NearMiss-1” retains the majority-class samples with the smallest average distances to their <em>K</em> nearest neighbors. For example, using <em>K</em> = 2, this table shows the distances between the minority and majority class samples:</p>
<div class="columns">
<div class="column" style="width:8%;">

</div><div class="column" style="width:84%;">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="cxyhclbrhd" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#cxyhclbrhd table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#cxyhclbrhd thead, #cxyhclbrhd tbody, #cxyhclbrhd tfoot, #cxyhclbrhd tr, #cxyhclbrhd td, #cxyhclbrhd th {
  border-style: none;
}

#cxyhclbrhd p {
  margin: 0;
  padding: 0;
}

#cxyhclbrhd .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: 80%;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#cxyhclbrhd .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#cxyhclbrhd .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#cxyhclbrhd .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#cxyhclbrhd .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#cxyhclbrhd .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#cxyhclbrhd .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#cxyhclbrhd .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#cxyhclbrhd .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#cxyhclbrhd .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#cxyhclbrhd .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#cxyhclbrhd .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#cxyhclbrhd .gt_spanner_row {
  border-bottom-style: hidden;
}

#cxyhclbrhd .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#cxyhclbrhd .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#cxyhclbrhd .gt_from_md > :first-child {
  margin-top: 0;
}

#cxyhclbrhd .gt_from_md > :last-child {
  margin-bottom: 0;
}

#cxyhclbrhd .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#cxyhclbrhd .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#cxyhclbrhd .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#cxyhclbrhd .gt_row_group_first td {
  border-top-width: 2px;
}

#cxyhclbrhd .gt_row_group_first th {
  border-top-width: 2px;
}

#cxyhclbrhd .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#cxyhclbrhd .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#cxyhclbrhd .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#cxyhclbrhd .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#cxyhclbrhd .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#cxyhclbrhd .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#cxyhclbrhd .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#cxyhclbrhd .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#cxyhclbrhd .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#cxyhclbrhd .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#cxyhclbrhd .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#cxyhclbrhd .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#cxyhclbrhd .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#cxyhclbrhd .gt_left {
  text-align: left;
}

#cxyhclbrhd .gt_center {
  text-align: center;
}

#cxyhclbrhd .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#cxyhclbrhd .gt_font_normal {
  font-weight: normal;
}

#cxyhclbrhd .gt_font_bold {
  font-weight: bold;
}

#cxyhclbrhd .gt_font_italic {
  font-style: italic;
}

#cxyhclbrhd .gt_super {
  font-size: 65%;
}

#cxyhclbrhd .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#cxyhclbrhd .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#cxyhclbrhd .gt_indent_1 {
  text-indent: 5px;
}

#cxyhclbrhd .gt_indent_2 {
  text-indent: 10px;
}

#cxyhclbrhd .gt_indent_3 {
  text-indent: 15px;
}

#cxyhclbrhd .gt_indent_4 {
  text-indent: 20px;
}

#cxyhclbrhd .gt_indent_5 {
  text-indent: 25px;
}

#cxyhclbrhd .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#cxyhclbrhd div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings gt_spanner_row header">
<th rowspan="2" id="Minority" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Minority</th>
<th colspan="6" id="Majority Point Labels" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" scope="colgroup"><div class="gt_column_spanner">
Majority Point Labels
</div></th>
</tr>
<tr class="gt_col_headings even">
<th id="a1" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">1</th>
<th id="a2" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">2</th>
<th id="a3" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">3</th>
<th id="a4" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">4</th>
<th id="a5" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">5</th>
<th id="a6" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">6</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="Minority">7</td>
<td class="gt_row gt_right" headers="1" style="background-color: #B0E0E6">0.46</td>
<td class="gt_row gt_right" headers="2" style="background-color: #B0E0E6">0.41</td>
<td class="gt_row gt_right" headers="3">1.41</td>
<td class="gt_row gt_right" headers="4">2.33</td>
<td class="gt_row gt_right" headers="5">3.10</td>
<td class="gt_row gt_right" headers="6">3.73</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Minority">8</td>
<td class="gt_row gt_right" headers="1" style="background-color: #B0E0E6">0.83</td>
<td class="gt_row gt_right" headers="2" style="background-color: #B0E0E6">0.64</td>
<td class="gt_row gt_right" headers="3" style="background-color: #B0E0E6">1.22</td>
<td class="gt_row gt_right" headers="4">1.62</td>
<td class="gt_row gt_right" headers="5">2.26</td>
<td class="gt_row gt_right" headers="6">2.94</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Minority">9</td>
<td class="gt_row gt_right" headers="1">1.77</td>
<td class="gt_row gt_right" headers="2">2.00</td>
<td class="gt_row gt_right" headers="3" style="background-color: #B0E0E6">1.01</td>
<td class="gt_row gt_right" headers="4" style="background-color: #B0E0E6">0.12</td>
<td class="gt_row gt_right" headers="5" style="background-color: #B0E0E6">0.95</td>
<td class="gt_row gt_right" headers="6" style="background-color: #B0E0E6">1.53</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Minority" style="border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #D3D3D3">10</td>
<td class="gt_row gt_right" headers="1" style="border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #D3D3D3">2.99</td>
<td class="gt_row gt_right" headers="2" style="border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #D3D3D3">3.06</td>
<td class="gt_row gt_right" headers="3" style="border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #D3D3D3">2.40</td>
<td class="gt_row gt_right" headers="4" style="background-color: #B0E0E6; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #D3D3D3">1.29</td>
<td class="gt_row gt_right" headers="5" style="background-color: #B0E0E6; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #D3D3D3">0.57</td>
<td class="gt_row gt_right" headers="6" style="background-color: #B0E0E6; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #D3D3D3">0.89</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Minority">2NN Mean</td>
<td class="gt_row gt_right" headers="1">0.65</td>
<td class="gt_row gt_right" headers="2">0.53</td>
<td class="gt_row gt_right" headers="3">1.11</td>
<td class="gt_row gt_right" headers="4">0.71</td>
<td class="gt_row gt_right" headers="5">0.76</td>
<td class="gt_row gt_right" headers="6">1.21</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div><div class="column" style="width:8%;">

</div>
</div>
<p>For the first majority-class observation, its closest minority-class samples are #7 and #8 (each column’s two nearest neighbors are highlighted with a background accent color). The average distance between its two neighbors is 0.65. To balance the data, NearMiss-1 would retain four samples: #1, #2, #4, and #5.</p>
<p>The algorithm for the second NearMiss variant focuses on using the <em>K</em> farthest neighbors, i.e., those with the largest distance between points. However, the instructions from <span class="citation" data-cites="mani2003knn">(<a href="#ref-mani2003knn" role="doc-biblioref"><strong>mani2003knn?</strong></a>)</span> are somewhat ambiguous:</p>
<blockquote class="blockquote">
<p>The second method (NearMiss-2) selects [majority] examples that are close to <em>all</em> [minority] examples. In this method, examples are selected based on their average distances to the three farthest [minority] examples.</p>
</blockquote>
<p>It is unclear whether the largest or the smallest average distance is used to determine which majority class data to keep. We’ll use the minimum average distance here.</p>
<p>This table highlights the two furthest neighbors (i.e., “2FN”) and their average distances:</p>
<div class="columns">
<div class="column" style="width:8%;">

</div><div class="column" style="width:84%;">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="jsewszanvf" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#jsewszanvf table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#jsewszanvf thead, #jsewszanvf tbody, #jsewszanvf tfoot, #jsewszanvf tr, #jsewszanvf td, #jsewszanvf th {
  border-style: none;
}

#jsewszanvf p {
  margin: 0;
  padding: 0;
}

#jsewszanvf .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: 80%;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#jsewszanvf .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#jsewszanvf .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#jsewszanvf .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#jsewszanvf .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#jsewszanvf .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#jsewszanvf .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#jsewszanvf .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#jsewszanvf .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#jsewszanvf .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#jsewszanvf .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#jsewszanvf .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#jsewszanvf .gt_spanner_row {
  border-bottom-style: hidden;
}

#jsewszanvf .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#jsewszanvf .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#jsewszanvf .gt_from_md > :first-child {
  margin-top: 0;
}

#jsewszanvf .gt_from_md > :last-child {
  margin-bottom: 0;
}

#jsewszanvf .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#jsewszanvf .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#jsewszanvf .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#jsewszanvf .gt_row_group_first td {
  border-top-width: 2px;
}

#jsewszanvf .gt_row_group_first th {
  border-top-width: 2px;
}

#jsewszanvf .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#jsewszanvf .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#jsewszanvf .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#jsewszanvf .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#jsewszanvf .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#jsewszanvf .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#jsewszanvf .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#jsewszanvf .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#jsewszanvf .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#jsewszanvf .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#jsewszanvf .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#jsewszanvf .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#jsewszanvf .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#jsewszanvf .gt_left {
  text-align: left;
}

#jsewszanvf .gt_center {
  text-align: center;
}

#jsewszanvf .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#jsewszanvf .gt_font_normal {
  font-weight: normal;
}

#jsewszanvf .gt_font_bold {
  font-weight: bold;
}

#jsewszanvf .gt_font_italic {
  font-style: italic;
}

#jsewszanvf .gt_super {
  font-size: 65%;
}

#jsewszanvf .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#jsewszanvf .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#jsewszanvf .gt_indent_1 {
  text-indent: 5px;
}

#jsewszanvf .gt_indent_2 {
  text-indent: 10px;
}

#jsewszanvf .gt_indent_3 {
  text-indent: 15px;
}

#jsewszanvf .gt_indent_4 {
  text-indent: 20px;
}

#jsewszanvf .gt_indent_5 {
  text-indent: 25px;
}

#jsewszanvf .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#jsewszanvf div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings gt_spanner_row header">
<th rowspan="2" id="Minority" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Minority</th>
<th colspan="6" id="Majority Point Labels" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" scope="colgroup"><div class="gt_column_spanner">
Majority Point Labels
</div></th>
</tr>
<tr class="gt_col_headings even">
<th id="a1" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">1</th>
<th id="a2" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">2</th>
<th id="a3" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">3</th>
<th id="a4" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">4</th>
<th id="a5" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">5</th>
<th id="a6" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">6</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="Minority">7</td>
<td class="gt_row gt_right" headers="1">0.46</td>
<td class="gt_row gt_right" headers="2">0.41</td>
<td class="gt_row gt_right" headers="3" style="background-color: #B0E0E6">1.41</td>
<td class="gt_row gt_right" headers="4" style="background-color: #B0E0E6">2.33</td>
<td class="gt_row gt_right" headers="5" style="background-color: #B0E0E6">3.10</td>
<td class="gt_row gt_right" headers="6" style="background-color: #B0E0E6">3.73</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Minority">8</td>
<td class="gt_row gt_right" headers="1">0.83</td>
<td class="gt_row gt_right" headers="2">0.64</td>
<td class="gt_row gt_right" headers="3">1.22</td>
<td class="gt_row gt_right" headers="4" style="background-color: #B0E0E6">1.62</td>
<td class="gt_row gt_right" headers="5" style="background-color: #B0E0E6">2.26</td>
<td class="gt_row gt_right" headers="6" style="background-color: #B0E0E6">2.94</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Minority">9</td>
<td class="gt_row gt_right" headers="1" style="background-color: #B0E0E6">1.77</td>
<td class="gt_row gt_right" headers="2" style="background-color: #B0E0E6">2.00</td>
<td class="gt_row gt_right" headers="3">1.01</td>
<td class="gt_row gt_right" headers="4">0.12</td>
<td class="gt_row gt_right" headers="5">0.95</td>
<td class="gt_row gt_right" headers="6">1.53</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Minority" style="border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #D3D3D3">10</td>
<td class="gt_row gt_right" headers="1" style="background-color: #B0E0E6; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #D3D3D3">2.99</td>
<td class="gt_row gt_right" headers="2" style="background-color: #B0E0E6; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #D3D3D3">3.06</td>
<td class="gt_row gt_right" headers="3" style="background-color: #B0E0E6; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #D3D3D3">2.40</td>
<td class="gt_row gt_right" headers="4" style="border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #D3D3D3">1.29</td>
<td class="gt_row gt_right" headers="5" style="border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #D3D3D3">0.57</td>
<td class="gt_row gt_right" headers="6" style="border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #D3D3D3">0.89</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Minority">2FN Mean</td>
<td class="gt_row gt_right" headers="1">2.38</td>
<td class="gt_row gt_right" headers="2">2.53</td>
<td class="gt_row gt_right" headers="3">1.90</td>
<td class="gt_row gt_right" headers="4">1.98</td>
<td class="gt_row gt_right" headers="5">2.68</td>
<td class="gt_row gt_right" headers="6">3.34</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div><div class="column" style="width:8%;">

</div>
</div>
<p>Note that the neighbors are the opposite of those in the previous table. In this instance, we would retain samples #1, #2, #3, and #4.</p>
<p>NearMiss-3 is a two-step process. First, the nearest <em>K</em><sub>1</sub> nearest neighbors are found for each minority sample. Any majority-class samples that were not on the list of neighbors are excluded. After this, we determine the <em>K</em><sub>2</sub> nearest neighbors of the majority class samples. Of these, the majority class observations with the <em>largest</em> average distance are retained.</p>
<p>In our example, we’ll use two neighbors for both calculations. In the first stage, the majority sample #3 is not a neighbor of any minority-class point, so it is discarded.</p>
<p>This table shows the reduced distance matrix and the average distances:</p>
<div class="columns">
<div class="column" style="width:8%;">

</div><div class="column" style="width:84%;">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="empaxdpfnf" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#empaxdpfnf table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#empaxdpfnf thead, #empaxdpfnf tbody, #empaxdpfnf tfoot, #empaxdpfnf tr, #empaxdpfnf td, #empaxdpfnf th {
  border-style: none;
}

#empaxdpfnf p {
  margin: 0;
  padding: 0;
}

#empaxdpfnf .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: 80%;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#empaxdpfnf .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#empaxdpfnf .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#empaxdpfnf .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#empaxdpfnf .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#empaxdpfnf .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#empaxdpfnf .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#empaxdpfnf .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#empaxdpfnf .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#empaxdpfnf .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#empaxdpfnf .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#empaxdpfnf .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#empaxdpfnf .gt_spanner_row {
  border-bottom-style: hidden;
}

#empaxdpfnf .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#empaxdpfnf .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#empaxdpfnf .gt_from_md > :first-child {
  margin-top: 0;
}

#empaxdpfnf .gt_from_md > :last-child {
  margin-bottom: 0;
}

#empaxdpfnf .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#empaxdpfnf .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#empaxdpfnf .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#empaxdpfnf .gt_row_group_first td {
  border-top-width: 2px;
}

#empaxdpfnf .gt_row_group_first th {
  border-top-width: 2px;
}

#empaxdpfnf .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#empaxdpfnf .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#empaxdpfnf .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#empaxdpfnf .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#empaxdpfnf .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#empaxdpfnf .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#empaxdpfnf .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#empaxdpfnf .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#empaxdpfnf .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#empaxdpfnf .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#empaxdpfnf .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#empaxdpfnf .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#empaxdpfnf .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#empaxdpfnf .gt_left {
  text-align: left;
}

#empaxdpfnf .gt_center {
  text-align: center;
}

#empaxdpfnf .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#empaxdpfnf .gt_font_normal {
  font-weight: normal;
}

#empaxdpfnf .gt_font_bold {
  font-weight: bold;
}

#empaxdpfnf .gt_font_italic {
  font-style: italic;
}

#empaxdpfnf .gt_super {
  font-size: 65%;
}

#empaxdpfnf .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#empaxdpfnf .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#empaxdpfnf .gt_indent_1 {
  text-indent: 5px;
}

#empaxdpfnf .gt_indent_2 {
  text-indent: 10px;
}

#empaxdpfnf .gt_indent_3 {
  text-indent: 15px;
}

#empaxdpfnf .gt_indent_4 {
  text-indent: 20px;
}

#empaxdpfnf .gt_indent_5 {
  text-indent: 25px;
}

#empaxdpfnf .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#empaxdpfnf div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings gt_spanner_row header">
<th rowspan="2" id="Minority" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Minority</th>
<th colspan="5" id="Majority Point Labels" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" scope="colgroup"><div class="gt_column_spanner">
Majority Point Labels
</div></th>
</tr>
<tr class="gt_col_headings even">
<th id="a1" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">1</th>
<th id="a2" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">2</th>
<th id="a4" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">4</th>
<th id="a5" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">5</th>
<th id="a6" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">6</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="Minority">7</td>
<td class="gt_row gt_right" headers="1" style="background-color: #B0E0E6">0.46</td>
<td class="gt_row gt_right" headers="2" style="background-color: #B0E0E6">0.41</td>
<td class="gt_row gt_right" headers="4">2.33</td>
<td class="gt_row gt_right" headers="5">3.10</td>
<td class="gt_row gt_right" headers="6">3.73</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Minority">8</td>
<td class="gt_row gt_right" headers="1" style="background-color: #B0E0E6">0.83</td>
<td class="gt_row gt_right" headers="2" style="background-color: #B0E0E6">0.64</td>
<td class="gt_row gt_right" headers="4">1.62</td>
<td class="gt_row gt_right" headers="5">2.26</td>
<td class="gt_row gt_right" headers="6">2.94</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Minority">9</td>
<td class="gt_row gt_right" headers="1">1.77</td>
<td class="gt_row gt_right" headers="2">2.00</td>
<td class="gt_row gt_right" headers="4" style="background-color: #B0E0E6">0.12</td>
<td class="gt_row gt_right" headers="5" style="background-color: #B0E0E6">0.95</td>
<td class="gt_row gt_right" headers="6" style="background-color: #B0E0E6">1.53</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Minority" style="border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #D3D3D3">10</td>
<td class="gt_row gt_right" headers="1" style="border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #D3D3D3">2.99</td>
<td class="gt_row gt_right" headers="2" style="border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #D3D3D3">3.06</td>
<td class="gt_row gt_right" headers="4" style="background-color: #B0E0E6; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #D3D3D3">1.29</td>
<td class="gt_row gt_right" headers="5" style="background-color: #B0E0E6; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #D3D3D3">0.57</td>
<td class="gt_row gt_right" headers="6" style="background-color: #B0E0E6; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #D3D3D3">0.89</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Minority">2NN Mean</td>
<td class="gt_row gt_right" headers="1">0.65</td>
<td class="gt_row gt_right" headers="2">0.53</td>
<td class="gt_row gt_right" headers="4">0.71</td>
<td class="gt_row gt_right" headers="5">0.76</td>
<td class="gt_row gt_right" headers="6">1.21</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div><div class="column" style="width:8%;">

</div>
</div>
<p>Based on these distances, NearMiss-3 selects #1, #4, #5, and #6 to include in the majority class.</p>
<p>Tomek Links <span class="citation" data-cites="ivan1976two">(<a href="#ref-ivan1976two" role="doc-biblioref"><strong>ivan1976two?</strong></a>)</span> is a filtering method that is the opposite of NearMiss. In this case, we will <em>remove</em> data points that are close to some theoretical class boundary. The goal is to create a sort of gap between the predictor distributions for each class. For each class, we determine the (single) nearest neighbor from the opposite class. Two samples form a Tomek Link when they are each other’s nearest neighbors and belong to opposing classes. We would remove both data points that form such a link. <span class="citation" data-cites="kubat1997addressing">(<a href="#ref-kubat1997addressing" role="doc-biblioref"><strong>kubat1997addressing?</strong></a>)</span> describe algorithms with similar goals.</p>
<p>An easy example from <a href="#fig-near-miss" class="quarto-xref">Figure&nbsp;<span>20.10</span></a> is the closeness of samples #4 and #9. They are extremely close to one another, yet in different classes. A counter-example is sample #3; its neighbor is #9, but the converse is not true since #9 and #4 are neighbors too. For this data set, only samples #1, #3, #6, and #8 are <em>not</em> Tomek Links and these are retained.</p>
<p>When applied to the myopia data, the number of myopic samples is reduced from 60 to 39 and the number of non-myopic rows in the training set drops from 402 to 381. While the reduction in events might compromise the model’s effectiveness, <a href="#fig-myopia-subsampling" class="quarto-xref">Figure&nbsp;<span>20.8</span></a> shows that the FDA class boundaries produced with the entire data set and the reduced version are extremely similar.</p>
<p>Another potential downside to removing Tomek Links is increased instability. Using a single nearest-neighbor approach yields high variance, since small changes in the data can lead to substantially different solutions. That added variance in the training set might be passed along to the classifier.</p>
<p>Removing Tomek Links is a process that can be applied to data sets with balanced or unbalanced class frequencies; the goal is to reduce overlap in predictor distributions so the model can find a clearer trend in the data. It can also be used in conjunction with other sampling or synthesis methods, preferably afterwards.</p>
</section>
<section id="sec-borderline" class="level4" data-number="20.5.1.6">
<h4 data-number="20.5.1.6" class="anchored" data-anchor-id="sec-borderline"><span class="header-section-number">20.5.1.6</span> Boarderline Methods</h4>
</section>
<section id="sec-myopia-sampling" class="level4" data-number="20.5.1.7">
<h4 data-number="20.5.1.7" class="anchored" data-anchor-id="sec-myopia-sampling"><span class="header-section-number">20.5.1.7</span> Comparisons Using the Myopia Data</h4>
<p>The top panel of <a href="#fig-myopia-sampling" class="quarto-xref">Figure&nbsp;<span>20.11</span></a> shows the model configuration statistics for different sampling and synthesis methods. The visualization emulates an ROC curve by plotting the sensitivity versus the false positive rate (i.e., one minus specificity) to demonstrate the trade-offs between the two types of errors. The downsampling panel shows a tight cluster of model results for both types of models, located in the region where sensitivity and specificity are approximately equal. Unsurprisingly, this is due to the equal frequencies of the two classes in the training data (post-sampling). However, this will not always be the case for other data sets. Near-miss sampling has a similar pattern with tighter clustering of model configuration results.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-myopia-sampling" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-myopia-sampling-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="cls-imbalance_files/figure-html/fig-myopia-sampling-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-myopia-sampling-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.11: Cross-validated statistics for the subsampling and synthesis methods.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The two synthetic methods showed slightly different patterns. ROSE and SMOTE with logistic regression yielded another tight cluster of results, with somewhat smaller statistics than those obtained through downsampling. For boosting, both SMOTE and ROSE demonstrated greater versatility in the tuning parameter results, enabling trade-offs between sensitivity and specificity. However, the pattern of the configurations favored specificity over sensitivity, especially for SMOTE.</p>
<p>The bottom panel of <a href="#fig-myopia-sampling" class="quarto-xref">Figure&nbsp;<span>20.11</span></a> shows that, when sensitivity is improved by these tools, there can be a corresponding increase in the Brier scores. The boosting results show that a high sensitivity raises the Brier to values that would indicate a complete lack of calibration in the predicted probability estimates. This is deliberate; the goal of rebalancing is to have parity in the class frequencies. This enables the model to increase the likelihood of identifying events in the data. The consequence of doing so is that our class probability distributions are biased towards overestimating the probability of an event. However, when assessing the model, we use unbalanced data, and the increased probability of an event is not consistent with the true event rate (as seen outside of the balanced training set).</p>
<p>It is worth noting that we could also optimize the threshold to further fine-tune the sensitivity and specificity values. Unlike the analysis in the previous section, the custom thresholds are much less likely to be excessively small (or large). However, if this is required, we are probably better off using unsampled training sets or using cost-sensitive learning (shown in the next section).</p>
<p>We can see that these tools have an effect on the hard class prediction metrics, such as sensitivity and specificity. Although <a href="#fig-myopia-sampling" class="quarto-xref">Figure&nbsp;<span>20.11</span></a> indicates that the calibration properties are not good, meaning that probability estimates do not reflect the rate at which events occur. However, it is possible that the probabilities can help discriminate between the classes for some threshold. For the four sampling methods used on these data, their ROC AUC values for the best logistic regression models ranged from 0.823 to 0.862 The range for the boosted tree models was 0.84 to 0.861. Are these any better or worse than the models that were developed in <a href="#sec-imbalance-acceptance" class="quarto-xref"><span>Section 20.4</span></a>? Using the bootstrap techniques in <a href="comparing-models.html#sec-compare-holdout" class="quarto-xref"><span>Section 14.2</span></a>, we linked the predictions by row for all of these models, created 2,000 bootstrap samples, and then computed the difference in the area under the ROC curves. <a href="#fig-myopia-sampling-comparison" class="quarto-xref">Figure&nbsp;<span>20.12</span></a> shows the results. For these data, there doesn’t appear to be any improvement in the ROC AUCs when subsampling and synthesis tools are used. Note that the x-axis scale is fairly small; these AUC values are very similar to one another. One comparison did not cover zero, indicating that using logistic regression with SMOTE had a slightly worse AUC than simply using the training set as is.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-myopia-sampling-comparison" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-myopia-sampling-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="cls-imbalance_files/figure-html/fig-myopia-sampling-comparison-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-myopia-sampling-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.12: Bootstrap 90% confidence intervals to assess whether subsampling and synthesis methods improve the area under the ROC curve. Negative values indicate that the AUC values were higher for models developed in <a href="#sec-imbalance-acceptance" class="quarto-xref"><span>Section 20.4</span></a>.
</figcaption>
</figure>
</div>
</div>
</div>
<p>These results highlights the idea that rebalancing tools can help a model do better at finding events and that the user should only focus on hard class predictions (and perhaps avoid exposing the users to the probability estimates).</p>
</section>
</section>
<section id="sec-cost-sensitive-learning" class="level3" data-number="20.5.2">
<h3 data-number="20.5.2" class="anchored" data-anchor-id="sec-cost-sensitive-learning"><span class="header-section-number">20.5.2</span> Cost-Sensitive Learning</h3>
<p>We’ve previously talked about the consequences of making an incorrect prediction. For example, <a href="cls-metrics.html#sec-mushrooms" class="quarto-xref"><span>Section 15.3</span></a> showed a model that predicts whether mushrooms are poisonous or not. We could think about this in terms of the general cost of a prediction (not too dissimilar to the discussion related to SVM models).</p>
<p>If we have <span class="math inline">\(C\)</span> classes, we could write down a cost matrix that defines the specific costs <span class="math inline">\(\mathcal{c}_{j|k}\)</span> of incorrectly predicting a data point to be class <span class="math inline">\(j\)</span> when it is truly class <span class="math inline">\(k\)</span>. In many instances, the diagonal terms of this matrix are zero since there is no real “cost” to making the correct prediction. There are cases where different types of benefits are associated with different types of correct predictions. See REF for an example. However, for the purposes of our discussion here, we will assume that the diagonal is zero.</p>
<p>If we have this cost structure, we can use the predicted class probabilities to estimate the expected costs for a collection of data by averaging a set of individual costs.</p>
<p>Let’s say that <span class="math inline">\(C=3\)</span> and the cost matrix is</p>
<p><span class="math display">\[
\mathcal{C} =
\begin{bmatrix}
0.00 &amp; 1.00 &amp; 3.00 \\
0.50 &amp; 0.00 &amp; 2.00 \\
0.25 &amp; 0.75 &amp; 0.00
\end{bmatrix}
\]</span></p>
<p>where the true values are in columns, and the predicted class levels are rows. For example, the cost of predicting a data point that is Class 3 as Class 1 is <span class="math inline">\(\mathcal{c}_{1|3} = 3.00\)</span>. Here are some examples of probabilities and their individual costs:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="odrxqfpwwv" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#odrxqfpwwv table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#odrxqfpwwv thead, #odrxqfpwwv tbody, #odrxqfpwwv tfoot, #odrxqfpwwv tr, #odrxqfpwwv td, #odrxqfpwwv th {
  border-style: none;
}

#odrxqfpwwv p {
  margin: 0;
  padding: 0;
}

#odrxqfpwwv .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#odrxqfpwwv .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#odrxqfpwwv .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#odrxqfpwwv .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#odrxqfpwwv .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#odrxqfpwwv .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#odrxqfpwwv .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#odrxqfpwwv .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#odrxqfpwwv .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#odrxqfpwwv .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#odrxqfpwwv .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#odrxqfpwwv .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#odrxqfpwwv .gt_spanner_row {
  border-bottom-style: hidden;
}

#odrxqfpwwv .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#odrxqfpwwv .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#odrxqfpwwv .gt_from_md > :first-child {
  margin-top: 0;
}

#odrxqfpwwv .gt_from_md > :last-child {
  margin-bottom: 0;
}

#odrxqfpwwv .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#odrxqfpwwv .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#odrxqfpwwv .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#odrxqfpwwv .gt_row_group_first td {
  border-top-width: 2px;
}

#odrxqfpwwv .gt_row_group_first th {
  border-top-width: 2px;
}

#odrxqfpwwv .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#odrxqfpwwv .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#odrxqfpwwv .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#odrxqfpwwv .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#odrxqfpwwv .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#odrxqfpwwv .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#odrxqfpwwv .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#odrxqfpwwv .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#odrxqfpwwv .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#odrxqfpwwv .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#odrxqfpwwv .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#odrxqfpwwv .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#odrxqfpwwv .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#odrxqfpwwv .gt_left {
  text-align: left;
}

#odrxqfpwwv .gt_center {
  text-align: center;
}

#odrxqfpwwv .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#odrxqfpwwv .gt_font_normal {
  font-weight: normal;
}

#odrxqfpwwv .gt_font_bold {
  font-weight: bold;
}

#odrxqfpwwv .gt_font_italic {
  font-style: italic;
}

#odrxqfpwwv .gt_super {
  font-size: 65%;
}

#odrxqfpwwv .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#odrxqfpwwv .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#odrxqfpwwv .gt_indent_1 {
  text-indent: 5px;
}

#odrxqfpwwv .gt_indent_2 {
  text-indent: 10px;
}

#odrxqfpwwv .gt_indent_3 {
  text-indent: 15px;
}

#odrxqfpwwv .gt_indent_4 {
  text-indent: 20px;
}

#odrxqfpwwv .gt_indent_5 {
  text-indent: 25px;
}

#odrxqfpwwv .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#odrxqfpwwv div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-bootstrap="false">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="gt_col_headings gt_spanner_row header">
<th rowspan="2" id="Truth" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col">Truth</th>
<th colspan="3" id="Probability Estimates" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" scope="colgroup"><div class="gt_column_spanner">
Probability Estimates
</div></th>
<th rowspan="2" id="Cost" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Cost</th>
</tr>
<tr class="gt_col_headings even">
<th id="A" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">A</th>
<th id="B" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">B</th>
<th id="C" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">C</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_center" headers="Truth">A</td>
<td class="gt_row gt_right" headers="A">0.33</td>
<td class="gt_row gt_right" headers="B">0.33</td>
<td class="gt_row gt_right" headers="C">0.33</td>
<td class="gt_row gt_right" headers="Cost">0.25</td>
</tr>
<tr class="even">
<td class="gt_row gt_center" headers="Truth">B</td>
<td class="gt_row gt_right" headers="A">0.33</td>
<td class="gt_row gt_right" headers="B">0.33</td>
<td class="gt_row gt_right" headers="C">0.33</td>
<td class="gt_row gt_right" headers="Cost">0.58</td>
</tr>
<tr class="odd">
<td class="gt_row gt_center" headers="Truth">C</td>
<td class="gt_row gt_right" headers="A">0.33</td>
<td class="gt_row gt_right" headers="B">0.33</td>
<td class="gt_row gt_right" headers="C">0.33</td>
<td class="gt_row gt_right" headers="Cost">1.67</td>
</tr>
<tr class="even">
<td class="gt_row gt_center" headers="Truth">A</td>
<td class="gt_row gt_right" headers="A">0.10</td>
<td class="gt_row gt_right" headers="B">0.50</td>
<td class="gt_row gt_right" headers="C">0.40</td>
<td class="gt_row gt_right" headers="Cost">0.35</td>
</tr>
<tr class="odd">
<td class="gt_row gt_center" headers="Truth">C</td>
<td class="gt_row gt_right" headers="A">0.40</td>
<td class="gt_row gt_right" headers="B">0.50</td>
<td class="gt_row gt_right" headers="C">0.10</td>
<td class="gt_row gt_right" headers="Cost">2.20</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>If our ML model can utilize custom objective functions, minimizing the expected cost is a fairly rational way to ensure your model is fit for purpose. If not, we can use the expected cost to help optimize the tuning parameters of our model (as we did in <a href="#fig-class-cost" class="quarto-xref">Figure&nbsp;<span>20.6</span></a>).</p>
<p>Another way some researchers have parameterized cost is to collapse the matrix, resulting in a general cost for misclassifying a sample, regardless of what it was misclassified as. In this case, we sum the cost matrix over columns, resulting in one cost per class. XXX describes these as class weights. In our example matrix shown above, the class weights are <span class="math inline">\(\mathcal{C}_1 = 0.75\)</span>, <span class="math inline">\(\mathcal{C}_2 = 1.75\)</span>, and <span class="math inline">\(\mathcal{C}_3 = 5.00\)</span>. For a two-class outcome (e.g., myopia or not), the class weights are the same as the two off-diagonal entries in the cost matrix.</p>
<p>If we consider class-specific costs as weights, we can generalize many performance metrics to be cost-sensitive. For example, we can make the Brier score cost-sensitive using a modified version of <a href="cls-metrics.html#eq-brier" class="quarto-xref">Equation&nbsp;<span>15.25</span></a></p>
<p><span id="eq-brier-cost"><span class="math display">\[
Brier = \frac{1}{WC}\sum_{i=1}^n\sum_{k=1}^C w_k(y_{ik} - \hat{p}_{ik})^2
\tag{20.1}\]</span></span></p>
<p>where <span class="math inline">\(w_k\)</span> is the cost or weight for class <span class="math inline">\(k\)</span> and <span class="math inline">\(W\)</span> is the sum of the <span class="math inline">\(n\)</span> weights. If we have two classes and <span class="math inline">\(w_1 = 5\)</span> and <span class="math inline">\(w_2 = 1\)</span>, every data point whose true outcome is the first class will have five-fold more influence over the objective function. In this way, we can train the model to ensure that it performs better in predicting specific classes than others. This is the basis for <em>cost-sensitive learning</em><a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>.</p>
<p>In practice, our implementations of ML model metrics may or may not enable cost-sensitive learning. If not, they may have the capacity to handle <em>case weights</em>. These are numeric values associated with each row of the data set that specify how it should affect the computations. There are many types of case weights for different purposes. Here are a few examples:</p>
<ul>
<li><p>Frequency weights are integers that specify how often the specific predictor pattern occurs in the data. If there were two categorical predictions with a total of 25 combinations, a very large data set can be compressed by using a case weight that reflects how often each of the 25 patterns occurs. Frequency weights would be assigned to both the training and testing sets.</p></li>
<li><p>Importance weights are numbers (decimal and non-negative) that reflect how important the row is to the model fit. This is the type of weight that we’ve discussed above. Importance weights should only be assigned to the training set; the test set should not use them, as it should accurately reflect the state of the data in the real world.</p></li>
</ul>
<p>If the metric implementation allows for case weights, we can use importance weights to make them sensitive to different classes.</p>
<div class="note-box">
<p>While not related to class imbalances, importance weights are also useful for time-series data, where we would like more recent data to have a higher priority in the model fit. It can also be useful for dealing with problematic/anomalous data in a model. For example, data collected during the global COVID-19 pandemic can have a negative impact on fits, but it may still need to be included. Assigning these row small case weights may solve those issues.</p>
</div>
<p>Note that the scale of class weights may differ across metrics and/or models (as we’ll see below). For one type of model, minority class weights ranging from 1 to 50 might have the same performance as another model/metric that ranges from 1 to 5. There is some trial and error associated with tuning the weights.</p>
<p>If your problem has a well-known cost structure, likely expressed in units of currency, there is probably little ambiguity about it. Otherwise, we might use class weights to either decrease the likelihood of tragic errors from occurring in the model or to help the model overcome a severe class imbalance. In other words, the “importance” in importance weights could mean many different things.</p>
<p>CART book, resampling weights versus case weights</p>
<p>To visualize an example, <a href="#fig-myopia-cost-fda" class="quarto-xref">Figure&nbsp;<span>20.13</span></a> shows the same data as <a href="#fig-myopia-fda" class="quarto-xref">Figure&nbsp;<span>20.3</span></a>, but in this case, case weights were used so that the myopic data (in red) had a 15-fold larger impact on the objective function than the non-myopic children. The same FDA model was trained on the data, but it used the case weights. The result is a class boundary that bends in the middle, allowing it to encompass a greater portion of the minority class than the original fit.</p>
<div id="fig-myopia-cost-fda" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-myopia-cost-fda-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="cls-imbalance_files/figure-html/myopia-cost-grid-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-myopia-cost-fda-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.13: A flexible discriminant fit to the myopia training set using cost-sensitive learning. The myopic subjects had a 15-fold higher cost in the objective function and 43 of the 60 events (in red) are identified using the default 50% threshold. This figure is comparable with <a href="#fig-myopia-fda" class="quarto-xref">Figure&nbsp;<span>20.3</span></a> and <span class="quarto-unresolved-ref">?fig-myopia-down-fda</span>.
</figcaption>
</figure>
</div>
<p>Case weights based on the class can also approximate some of the subsampling methods shown in the previous section. For example, instead of dropping training set rows from the data, we can adjust the importance weights so that the sum of the weights in the majority class equals the sum of the weights in the minority class. By doing this, we may be able to obtain a better model since the majority of the majority class is not lost. Similarly, an approximation to upsampling would only increase the minority class weights so that the class weight totals are in equilibrium. This would also result in faster training times than basic oversampling.</p>
<p>It is worth noting that some stochastic ensemble implementations (e.g., boosting and random forests) often confuse the terms “case weights” and “sampling weights.” In these instances, the weights are used to preferentially sample the training set while fitting the models (usually trees) without directly impacting the objective function. This process is more akin to downsampling and upsampling than to cost-sensitive learning.</p>
<p>To demonstrate with the full myopia data set, boosted trees and regularized logistic regression were used once again. The lightgbm implementation was used and, while their documentation is unclear about how the weights are used, it appears that the weights are applied to the objective function and not just the sampling mechanism<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>.</p>
<p>The same grids were used as in the previous section for both models. For the case weights ranges for each model, some investigation was required to find appropriate changes in the performance metrics. While both parameter ranges were explored in log<sub>2</sub> units, starting at 1.0, the boosted model used a maximum weight of 2<sup>10</sup>, whereas logistic regression used maximum weights of 2<sup>4</sup>. The majority class weights were kept at a value of 1.0 for both models. For each model, a sequence of weights was created in a 1D grid, and these were crossed with the original grids.</p>
<p><a href="#fig-myopia-cost-sensitive" class="quarto-xref">Figure&nbsp;<span>20.14</span></a> shows the results where the ranges of the weights have been standardized across the two models to be within [0, 1]. In the top panel, another ROC-like visualization is used to demonstrate the effect of using higher weights for the myopic samples. We can see that both models tend to increase sensitivity as the weights increase<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>. This is not always the case, as some tuning parameters for the model were suboptimal on their own, and adjusting the class weights did not yield a significant change. For the most part, the increase in sensitivity comes with the price of reduced specificity. The different class weights enable us to select the optimal trade-off between the two.</p>
<p>As with subsampling and synthesis methods, the class probabilities generated by this model become increasingly inconsistent with reality as the cost of the minority class increases. The bottom panel shows the degradation in the Brier score tracks with increased sensitivity. Once again, we caution against using these probability estimates with users, as they may not accurately emulate the true likelihood of the event.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-myopia-cost-sensitive" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-myopia-cost-sensitive-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="cls-imbalance_files/figure-html/fig-myopia-cost-sensitive-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-myopia-cost-sensitive-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.14: Cross-validated statistics for the cost-sensitive models.
</figcaption>
</figure>
</div>
</div>
</div>
<p>When comparing subsampling/synthetic methods to cost-sensitive learning, the latter appears to be more versatile than the former. It enables the user to have more direct control over the trade-off between false-negative and false-positive rates. The downside to cost-sensitive learning is that it may be dependent on the implementation of the method, whereas subsampling/synthetic tools can be used anywhere, as they are specialized preprocessors.</p>
</section>
</section>
<section id="sec-prevalence-again" class="level2" data-number="20.6">
<h2 data-number="20.6" class="anchored" data-anchor-id="sec-prevalence-again"><span class="header-section-number">20.6</span> Revenge of the Prevalence</h2>
<p>It is worth revisiting the discussion from <a href="cls-metrics.html#sec-cls-two-classes" class="quarto-xref"><span>Section 15.5</span></a> on how the event rate (i.e., prevalence) affects important statistics. We’ll continue to use the myopia data for discussion.</p>
<p>If we assume that the rate of myopia in the population of interest is consistent with our data set (13.1%), we can gain a deeper understanding of how well the model performs. Given our estimates of sensitivity and specificity, the unconditional performance statistics are:</p>
<ul>
<li>positive predictive value (PPV): 38.2%</li>
<li>negative predictive value (NPV): 95.7%</li>
</ul>
<p>Even though our sensitivity and specificity ended up being fairly balanced, the statistics that convey to true ability to predict are not.</p>
<p>This could exacerbate the potential confusion that can occur when explaining the results of a prediction. Continuing the hypothetical conversation from <a href="#sec-imbalance-acceptance" class="quarto-xref"><span>Section 20.4</span></a>, the explanation of the PPV might be:</p>
<blockquote class="blockquote">
<p>“We understand that this rule of thumb might seem overly stringent. That said, from our data, we know that when we predict that a child is myopic, the probability that they are actually myopic is roughly 38%. This is because <em>most children are not myopic</em> but we do find some evidence to make the diagnosis.”</p>
</blockquote>
<p>Conversely, if the child had a very small predicted probability and a myopia diagnosis was not used, the explanation would be:</p>
<blockquote class="blockquote">
<p>“Even though the chances that your child is myopic are greater than zero, from our data we know that when we predict that a child is not myopic, the probability that they are actually not myopic is overwhelmingly high (roughly 96%). This is because <em>most children are not myopic</em> and there is not enough evidence to disprove this for your child.”</p>
</blockquote>
<p>This is much less ambiguous than the previous hypothetical conversation.</p>
<p>We can try to optimize the model for PPV and NPV in the same way as we did for sensitivity and specificity. However, to do this, the prevalence must be well known for the specific population that will be predicted by the model and should be stable over time.</p>
<p>For example, <span class="citation" data-cites="covidcdc">(<a href="#ref-covidcdc" role="doc-biblioref"><strong>covidcdc?</strong></a>)</span> calculated COVID-19 cases and deaths, and estimated cumulative incidence for March and April 2020. The mortality rate varied geographically. For example, during that period, New York City had an estimated mortality rate of 5.3%, while the remainder of the state of New York had an estimated rate of 2.2%. Thankfully, in 2025, these rates are much lower.</p>
<p>This illustrates that computations that depend on the event rate can be challenging, as the values can systematically change under different conditions and over time.</p>
</section>
<section id="chapter-references" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="chapter-references">Chapter References</h2>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-hosmer2013applied" class="csl-entry" role="listitem">
Hosmer, D, S Lemeshow, and R Sturdivant. 2013. <em>Applied Logistic Regression</em>. John Wiley &amp; Sons.
</div>
<div id="ref-apm" class="csl-entry" role="listitem">
Kuhn, M, and K Johnson. 2013. <em><span>Applied Predictive Modeling</span></em>. Springer.
</div>
</div>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>We use the original implementation of the glmnet model, which features a capability where, for a specific mixture value, a single model fit contains results for multiple penalty values. For this reason, we can evaluate a regular grid with 72 candidates with only 4 model fits, one for each mixture value. A regular grid exploits this feature, but a space-filling design would nullify this advantage.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Or a validation set if multiple resamples are not used.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>When adding the threshold to the optimization grid, it might be helpful to start with a space-filling design and <em>crossing</em> it with a vector of thresholds. This allows us to have data on the thresholds for each of the candidate points. There is minimal overhead associated with this approach, as the thresholding computations occur after preprocessing and model fitting. For example, if an initial grid with 25 points is crossed with 10 threshold values, there are still only 25 model configurations to train, which takes the longest time to compute.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>And validation set, if any<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>If there are more than two classes, you can substitute “non-majority” class here.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>Note that our previous use of costs in <a href="#fig-class-cost" class="quarto-xref">Figure&nbsp;<span>20.6</span></a> was <em>after</em> the model was trained. In this section, we will use weights/costs so that the model adapts to the cost structure during training.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>A GitHub issue (<a href="https://github.com/microsoft/LightGBM/issues/1299"><code>https://github.com/microsoft/LightGBM/issues/1299</code></a>) has evidence that the weights are a “multiplication applied to every positive label weight” and shows some C++ code to that effect.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>As with the previous section, these statistics use the default 50% threshold.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/aml4td\.org");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../chapters/cls-ensembles.html" class="pagination-link" aria-label="Classification Ensembles">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Classification Ensembles</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../chapters/cls-case-study.html" class="pagination-link" aria-label="Classification Case Study">
        <span class="nav-page-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Classification Case Study</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js" type="text/javascript"></script>
<script type="text/javascript">
(function(d) {
  d.querySelectorAll(".pseudocode-container").forEach(function(el) {
    let pseudocodeOptions = {
      indentSize: el.dataset.indentSize || "1.2em",
      commentDelimiter: el.dataset.commentDelimiter || "//",
      lineNumber: el.dataset.lineNumber === "true" ? true : false,
      lineNumberPunc: el.dataset.lineNumberPunc || ":",
      noEnd: el.dataset.noEnd === "true" ? true : false,
      titlePrefix: el.dataset.algTitle || "Algorithm"
    };
    pseudocode.renderElement(el.querySelector(".pseudocode"), pseudocodeOptions);
  });
})(document);
(function(d) {
  d.querySelectorAll(".pseudocode-container").forEach(function(el) {
    titleSpan = el.querySelector(".ps-root > .ps-algorithm > .ps-line > .ps-keyword")
    titlePrefix = el.dataset.algTitle;
    titleIndex = el.dataset.chapterLevel ? el.dataset.chapterLevel + "." + el.dataset.pseudocodeIndex : el.dataset.pseudocodeIndex;
    titleSpan.innerHTML = titlePrefix + " " + titleIndex + " ";
  });
})(document);
</script>




</body></html>